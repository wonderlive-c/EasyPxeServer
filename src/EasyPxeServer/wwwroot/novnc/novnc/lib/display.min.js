/**
 * Minified by jsDelivr using Terser v5.39.0.
 * Original file: /npm/@novnc/novnc@1.6.0/lib/display.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var Log=_interopRequireWildcard(require("./util/logging.js")),_base=_interopRequireDefault(require("./base64.js")),_int=require("./util/int.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,i=new WeakMap;return(_getRequireWildcardCache=function(e){return e?i:t})(e)}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=_typeof(e)&&"function"!=typeof e)return{default:e};var i=_getRequireWildcardCache(t);if(i&&i.has(e))return i.get(e);var r={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var h in e)if("default"!==h&&{}.hasOwnProperty.call(e,h)){var o=a?Object.getOwnPropertyDescriptor(e,h):null;o&&(o.get||o.set)?Object.defineProperty(r,h,o):r[h]=e[h]}return r.default=e,i&&i.set(e,r),r}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,_toPropertyKey(r.key),r)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=_typeof(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var Display=exports.default=function(){return _createClass((function e(t){if(_classCallCheck(this,e),this._drawCtx=null,this._renderQ=[],this._flushPromise=null,this._fbWidth=0,this._fbHeight=0,this._prevDrawStyle="",Log.Debug(">> Display.constructor"),this._target=t,!this._target)throw new Error("Target must be set");if("string"==typeof this._target)throw new Error("target must be a DOM element");if(!this._target.getContext)throw new Error("no getContext method");this._targetCtx=this._target.getContext("2d"),this._viewportLoc={x:0,y:0,w:this._target.width,h:this._target.height},this._backbuffer=document.createElement("canvas"),this._drawCtx=this._backbuffer.getContext("2d"),this._damageBounds={left:0,top:0,right:this._backbuffer.width,bottom:this._backbuffer.height},Log.Debug("User Agent: "+navigator.userAgent),Log.Debug("<< Display.constructor"),this._scale=1,this._clipViewport=!1}),[{key:"scale",get:function(){return this._scale},set:function(e){this._rescale(e)}},{key:"clipViewport",get:function(){return this._clipViewport},set:function(e){this._clipViewport=e;var t=this._viewportLoc;this.viewportChangeSize(t.w,t.h),this.viewportChangePos(0,0)}},{key:"width",get:function(){return this._fbWidth}},{key:"height",get:function(){return this._fbHeight}},{key:"viewportChangePos",value:function(e,t){var i=this._viewportLoc;e=Math.floor(e),t=Math.floor(t),this._clipViewport||(e=-i.w,t=-i.h);var r=i.x+i.w-1,a=i.y+i.h-1;e<0&&i.x+e<0&&(e=-i.x),r+e>=this._fbWidth&&(e-=r+e-this._fbWidth+1),i.y+t<0&&(t=-i.y),a+t>=this._fbHeight&&(t-=a+t-this._fbHeight+1),0===e&&0===t||(Log.Debug("viewportChange deltaX: "+e+", deltaY: "+t),i.x+=e,i.y+=t,this._damage(i.x,i.y,i.w,i.h),this.flip())}},{key:"viewportChangeSize",value:function(e,t){this._clipViewport&&void 0!==e&&void 0!==t||(Log.Debug("Setting viewport to full display region"),e=this._fbWidth,t=this._fbHeight),e=Math.floor(e),t=Math.floor(t),e>this._fbWidth&&(e=this._fbWidth),t>this._fbHeight&&(t=this._fbHeight);var i=this._viewportLoc;if(i.w!==e||i.h!==t){i.w=e,i.h=t;var r=this._target;r.width=e,r.height=t,this.viewportChangePos(0,0),this._damage(i.x,i.y,i.w,i.h),this.flip(),this._rescale(this._scale)}}},{key:"absX",value:function(e){return 0===this._scale?0:(0,_int.toSigned32bit)(e/this._scale+this._viewportLoc.x)}},{key:"absY",value:function(e){return 0===this._scale?0:(0,_int.toSigned32bit)(e/this._scale+this._viewportLoc.y)}},{key:"resize",value:function(e,t){this._prevDrawStyle="",this._fbWidth=e,this._fbHeight=t;var i=this._backbuffer;if(i.width!==e||i.height!==t){var r=null;i.width>0&&i.height>0&&(r=this._drawCtx.getImageData(0,0,i.width,i.height)),i.width!==e&&(i.width=e),i.height!==t&&(i.height=t),r&&this._drawCtx.putImageData(r,0,0)}var a=this._viewportLoc;this.viewportChangeSize(a.w,a.h),this.viewportChangePos(0,0)}},{key:"getImageData",value:function(){return this._drawCtx.getImageData(0,0,this.width,this.height)}},{key:"toDataURL",value:function(e,t){return this._backbuffer.toDataURL(e,t)}},{key:"toBlob",value:function(e,t,i){return this._backbuffer.toBlob(e,t,i)}},{key:"_damage",value:function(e,t,i,r){e<this._damageBounds.left&&(this._damageBounds.left=e),t<this._damageBounds.top&&(this._damageBounds.top=t),e+i>this._damageBounds.right&&(this._damageBounds.right=e+i),t+r>this._damageBounds.bottom&&(this._damageBounds.bottom=t+r)}},{key:"flip",value:function(e){if(0===this._renderQ.length||e){var t=this._damageBounds.left,i=this._damageBounds.top,r=this._damageBounds.right-t,a=this._damageBounds.bottom-i,h=t-this._viewportLoc.x,o=i-this._viewportLoc.y;h<0&&(r+=h,t-=h,h=0),o<0&&(a+=o,i-=o,o=0),h+r>this._viewportLoc.w&&(r=this._viewportLoc.w-h),o+a>this._viewportLoc.h&&(a=this._viewportLoc.h-o),r>0&&a>0&&this._targetCtx.drawImage(this._backbuffer,t,i,r,a,h,o,r,a),this._damageBounds.left=this._damageBounds.top=65535,this._damageBounds.right=this._damageBounds.bottom=0}else this._renderQPush({type:"flip"})}},{key:"pending",value:function(){return this._renderQ.length>0}},{key:"flush",value:function(){var e=this;return 0===this._renderQ.length?Promise.resolve():(null===this._flushPromise&&(this._flushPromise=new Promise((function(t){e._flushResolve=t}))),this._flushPromise)}},{key:"fillRect",value:function(e,t,i,r,a,h){0===this._renderQ.length||h?(this._setFillColor(a),this._drawCtx.fillRect(e,t,i,r),this._damage(e,t,i,r)):this._renderQPush({type:"fill",x:e,y:t,width:i,height:r,color:a})}},{key:"copyImage",value:function(e,t,i,r,a,h,o){0===this._renderQ.length||o?(this._drawCtx.mozImageSmoothingEnabled=!1,this._drawCtx.webkitImageSmoothingEnabled=!1,this._drawCtx.msImageSmoothingEnabled=!1,this._drawCtx.imageSmoothingEnabled=!1,this._drawCtx.drawImage(this._backbuffer,e,t,a,h,i,r,a,h),this._damage(i,r,a,h)):this._renderQPush({type:"copy",oldX:e,oldY:t,x:i,y:r,width:a,height:h})}},{key:"imageRect",value:function(e,t,i,r,a,h){if(0!==i&&0!==r){var o=new Image;o.src="data: "+a+";base64,"+_base.default.encode(h),this._renderQPush({type:"img",img:o,x:e,y:t,width:i,height:r})}}},{key:"videoFrame",value:function(e,t,i,r,a){this._renderQPush({type:"frame",frame:a,x:e,y:t,width:i,height:r})}},{key:"blitImage",value:function(e,t,i,r,a,h,o){if(0===this._renderQ.length||o){var s=new Uint8ClampedArray(a.buffer,a.byteOffset+h,i*r*4),n=new ImageData(s,i,r);this._drawCtx.putImageData(n,e,t),this._damage(e,t,i,r)}else{var l=new Uint8Array(i*r*4);l.set(new Uint8Array(a.buffer,0,l.length)),this._renderQPush({type:"blit",data:l,x:e,y:t,width:i,height:r})}}},{key:"drawImage",value:function(e){for(var t,i=arguments.length,r=new Array(i>1?i-1:0),a=1;a<i;a++)r[a-1]=arguments[a];if((t=this._drawCtx).drawImage.apply(t,[e].concat(r)),r.length<=4){var h=r[0],o=r[1];this._damage(h,o,e.width,e.height)}else{var s=r[2],n=r[3],l=r[4],u=r[5];this._damage(l,u,s,n)}}},{key:"autoscale",value:function(e,t){var i;if(0===e||0===t)i=0;else{var r=this._viewportLoc,a=e/t;i=r.w/r.h>=a?e/r.w:t/r.h}this._rescale(i)}},{key:"_rescale",value:function(e){this._scale=e;var t=this._viewportLoc,i=e*t.w+"px",r=e*t.h+"px";this._target.style.width===i&&this._target.style.height===r||(this._target.style.width=i,this._target.style.height=r)}},{key:"_setFillColor",value:function(e){var t="rgb("+e[0]+","+e[1]+","+e[2]+")";t!==this._prevDrawStyle&&(this._drawCtx.fillStyle=t,this._prevDrawStyle=t)}},{key:"_renderQPush",value:function(e){this._renderQ.push(e),1===this._renderQ.length&&this._scanRenderQ()}},{key:"_resumeRenderQ",value:function(){this.removeEventListener("load",this._noVNCDisplay._resumeRenderQ),this._noVNCDisplay._scanRenderQ()}},{key:"_scanRenderQ",value:function(){for(var e,t=this,i=!0,r=function(){var e=t._renderQ[0];switch(e.type){case"flip":t.flip(!0);break;case"copy":t.copyImage(e.oldX,e.oldY,e.x,e.y,e.width,e.height,!0);break;case"fill":t.fillRect(e.x,e.y,e.width,e.height,e.color,!0);break;case"blit":t.blitImage(e.x,e.y,e.width,e.height,e.data,0,!0);break;case"img":if(e.img.complete){if(e.img.width!==e.width||e.img.height!==e.height)return Log.Error("Decoded image has incorrect dimensions. Got "+e.img.width+"x"+e.img.height+". Expected "+e.width+"x"+e.height+"."),{v:void 0};t.drawImage(e.img,e.x,e.y)}else e.img._noVNCDisplay=t,e.img.addEventListener("load",t._resumeRenderQ),i=!1;break;case"frame":if(e.frame.ready){var r=e.frame.frame;(r.codedWidth<e.width||r.codedHeight<e.height)&&Log.Warn("Decoded video frame does not cover its full rectangle area. Expecting at least "+e.width+"x"+e.height+" but got "+r.codedWidth+"x"+r.codedHeight);var a=e.width,h=e.height,o=e.x,s=e.y,n=a,l=h;t.drawImage(r,0,0,a,h,o,s,n,l),r.close()}else{var u=t;e.frame.promise.then((function(){u._scanRenderQ()})),i=!1}}i&&t._renderQ.shift()};i&&this._renderQ.length>0;)if(e=r())return e.v;0===this._renderQ.length&&null!==this._flushPromise&&(this._flushResolve(),this._flushPromise=null,this._flushResolve=null)}}])}();
//# sourceMappingURL=/sm/326281d6c103233b5fad7337006f74d0be5cf576e9517f1ac50b6e11ffcf4916.map