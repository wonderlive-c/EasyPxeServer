/**
 * Minified by jsDelivr using Terser v5.39.0.
 * Original file: /npm/@novnc/novnc@1.6.0/lib/decoders/tight.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var Log=_interopRequireWildcard(require("../util/logging.js")),_inflator=_interopRequireDefault(require("../inflator.js"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _getRequireWildcardCache(t){if("function"!=typeof WeakMap)return null;var e=new WeakMap,r=new WeakMap;return(_getRequireWildcardCache=function(t){return t?r:e})(t)}function _interopRequireWildcard(t,e){if(!e&&t&&t.__esModule)return t;if(null===t||"object"!=_typeof(t)&&"function"!=typeof t)return{default:t};var r=_getRequireWildcardCache(e);if(r&&r.has(t))return r.get(t);var i={__proto__:null},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in t)if("default"!==l&&{}.hasOwnProperty.call(t,l)){var a=n?Object.getOwnPropertyDescriptor(t,l):null;a&&(a.get||a.set)?Object.defineProperty(i,l,a):i[l]=t[l]}return i.default=t,r&&r.set(t,i),i}function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,_toPropertyKey(i.key),i)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(t,e){if("object"!=_typeof(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var i=r.call(t,e||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}var TightDecoder=exports.default=function(){return _createClass((function t(){_classCallCheck(this,t),this._ctl=null,this._filter=null,this._numColors=0,this._palette=new Uint8Array(1024),this._len=0,this._zlibs=[];for(var e=0;e<4;e++)this._zlibs[e]=new _inflator.default}),[{key:"decodeRect",value:function(t,e,r,i,n,l,a){if(null===this._ctl){if(n.rQwait("TIGHT compression-control",1))return!1;this._ctl=n.rQshift8();for(var s=0;s<4;s++)this._ctl>>s&1&&(this._zlibs[s].reset(),Log.Info("Reset zlib stream "+s));this._ctl=this._ctl>>4}var o;if(8===this._ctl)o=this._fillRect(t,e,r,i,n,l,a);else if(9===this._ctl)o=this._jpegRect(t,e,r,i,n,l,a);else if(10===this._ctl)o=this._pngRect(t,e,r,i,n,l,a);else{if(8&this._ctl)throw new Error("Illegal tight compression received (ctl: "+this._ctl+")");o=this._basicRect(this._ctl,t,e,r,i,n,l,a)}return o&&(this._ctl=null),o}},{key:"_fillRect",value:function(t,e,r,i,n,l,a){if(n.rQwait("TIGHT",3))return!1;var s=n.rQshiftBytes(3);return l.fillRect(t,e,r,i,s,!1),!0}},{key:"_jpegRect",value:function(t,e,r,i,n,l,a){var s=this._readData(n);return null!==s&&(l.imageRect(t,e,r,i,"image/jpeg",s),!0)}},{key:"_pngRect",value:function(t,e,r,i,n,l,a){throw new Error("PNG received in standard Tight rect")}},{key:"_basicRect",value:function(t,e,r,i,n,l,a,s){if(null===this._filter)if(4&t){if(l.rQwait("TIGHT",1))return!1;this._filter=l.rQshift8()}else this._filter=0;var o,f=3&t;switch(this._filter){case 0:o=this._copyFilter(f,e,r,i,n,l,a,s);break;case 1:o=this._paletteFilter(f,e,r,i,n,l,a,s);break;case 2:o=this._gradientFilter(f,e,r,i,n,l,a,s);break;default:throw new Error("Illegal tight filter received (ctl: "+this._filter+")")}return o&&(this._filter=null),o}},{key:"_copyFilter",value:function(t,e,r,i,n,l,a,s){var o,f=i*n*3;if(0===f)return!0;if(f<12){if(l.rQwait("TIGHT",f))return!1;o=l.rQshiftBytes(f)}else{if(null===(o=this._readData(l)))return!1;this._zlibs[t].setInput(o),o=this._zlibs[t].inflate(f),this._zlibs[t].setInput(null)}for(var u=new Uint8Array(i*n*4),c=0,_=0;c<i*n*4;c+=4,_+=3)u[c]=o[_],u[c+1]=o[_+1],u[c+2]=o[_+2],u[c+3]=255;return a.blitImage(e,r,i,n,u,0,!1),!0}},{key:"_paletteFilter",value:function(t,e,r,i,n,l,a,s){if(0===this._numColors){if(l.rQwait("TIGHT palette",1))return!1;var o=l.rQpeek8()+1,f=3*o;if(l.rQwait("TIGHT palette",1+f))return!1;this._numColors=o,l.rQskipBytes(1),l.rQshiftTo(this._palette,f)}var u,c=this._numColors<=2?1:8,_=Math.floor((i*c+7)/8)*n;if(0===_)return!0;if(_<12){if(l.rQwait("TIGHT",_))return!1;u=l.rQshiftBytes(_)}else{if(null===(u=this._readData(l)))return!1;this._zlibs[t].setInput(u),u=this._zlibs[t].inflate(_),this._zlibs[t].setInput(null)}return 2==this._numColors?this._monoRect(e,r,i,n,u,this._palette,a):this._paletteRect(e,r,i,n,u,this._palette,a),this._numColors=0,!0}},{key:"_monoRect",value:function(t,e,r,i,n,l,a){for(var s=this._getScratchBuffer(r*i*4),o=Math.floor((r+7)/8),f=Math.floor(r/8),u=0;u<i;u++){var c=void 0,_=void 0,h=void 0;for(h=0;h<f;h++)for(var p=7;p>=0;p--)c=4*(u*r+8*h+7-p),_=3*(n[u*o+h]>>p&1),s[c]=l[_],s[c+1]=l[_+1],s[c+2]=l[_+2],s[c+3]=255;for(var y=7;y>=8-r%8;y--)c=4*(u*r+8*h+7-y),_=3*(n[u*o+h]>>y&1),s[c]=l[_],s[c+1]=l[_+1],s[c+2]=l[_+2],s[c+3]=255}a.blitImage(t,e,r,i,s,0,!1)}},{key:"_paletteRect",value:function(t,e,r,i,n,l,a){for(var s=this._getScratchBuffer(r*i*4),o=r*i*4,f=0,u=0;f<o;f+=4,u++){var c=3*n[u];s[f]=l[c],s[f+1]=l[c+1],s[f+2]=l[c+2],s[f+3]=255}a.blitImage(t,e,r,i,s,0,!1)}},{key:"_gradientFilter",value:function(t,e,r,i,n,l,a,s){var o,f=i*n*3;if(0===f)return!0;if(f<12){if(l.rQwait("TIGHT",f))return!1;o=l.rQshiftBytes(f)}else{if(null===(o=this._readData(l)))return!1;this._zlibs[t].setInput(o),o=this._zlibs[t].inflate(f),this._zlibs[t].setInput(null)}for(var u=new Uint8Array(4*i*n),c=0,_=0,h=new Uint8Array(3),p=0;p<i;p++){for(var y=0;y<3;y++){var v=h[y],d=o[_++]+v;u[c++]=d,h[y]=d}u[c++]=255}for(var b=0,g=new Uint8Array(3),w=new Uint8Array(3),m=1;m<n;m++){h.fill(0),w.fill(0);for(var T=0;T<i;T++){for(var k=0;k<3;k++){g[k]=u[b++];var I=h[k]+g[k]-w[k];I<0?I=0:I>255&&(I=255);var Q=o[_++]+I;u[c++]=Q,w[k]=g[k],h[k]=Q}u[c++]=255,b++}}return a.blitImage(e,r,i,n,u,0,!1),!0}},{key:"_readData",value:function(t){if(0===this._len){if(t.rQwait("TIGHT",3))return null;var e;e=t.rQshift8(),this._len=127&e,128&e&&(e=t.rQshift8(),this._len|=(127&e)<<7,128&e&&(e=t.rQshift8(),this._len|=e<<14))}if(t.rQwait("TIGHT",this._len))return null;var r=t.rQshiftBytes(this._len,!1);return this._len=0,r}},{key:"_getScratchBuffer",value:function(t){return(!this._scratchBuffer||this._scratchBuffer.length<t)&&(this._scratchBuffer=new Uint8Array(t)),this._scratchBuffer}}])}();
//# sourceMappingURL=/sm/3be00d3d46adf3abce3486b63e7cbc02fb3b47957d86c5fbd9ef95450473dcd1.map