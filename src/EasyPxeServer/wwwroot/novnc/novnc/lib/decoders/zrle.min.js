/**
 * Minified by jsDelivr using Terser v5.39.0.
 * Original file: /npm/@novnc/novnc@1.6.0/lib/decoders/zrle.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _inflator=_interopRequireDefault(require("../inflator.js"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var ZRLE_TILE_WIDTH=64,ZRLE_TILE_HEIGHT=64,ZRLEDecoder=exports.default=function(){return _createClass((function e(){_classCallCheck(this,e),this._length=0,this._inflator=new _inflator.default,this._pixelBuffer=new Uint8Array(ZRLE_TILE_WIDTH*ZRLE_TILE_HEIGHT*4),this._tileBuffer=new Uint8Array(ZRLE_TILE_WIDTH*ZRLE_TILE_HEIGHT*4)}),[{key:"decodeRect",value:function(e,t,r,i,n,o,l){if(0===this._length){if(n.rQwait("ZLib data length",4))return!1;this._length=n.rQshift32()}if(n.rQwait("Zlib data",this._length))return!1;var a=n.rQshiftBytes(this._length,!1);this._inflator.setInput(a);for(var f=t;f<t+i;f+=ZRLE_TILE_HEIGHT)for(var _=Math.min(ZRLE_TILE_HEIGHT,t+i-f),s=e;s<e+r;s+=ZRLE_TILE_WIDTH){var u=Math.min(ZRLE_TILE_WIDTH,e+r-s),h=u*_,c=this._inflator.inflate(1)[0];if(0===c){var d=this._readPixels(h);o.blitImage(s,f,u,_,d,0,!1)}else if(1===c){var v=this._readPixels(1);o.fillRect(s,f,u,_,[v[0],v[1],v[2]])}else if(c>=2&&c<=16){var y=this._decodePaletteTile(c,h,u,_);o.blitImage(s,f,u,_,y,0,!1)}else if(128===c){var p=this._decodeRLETile(h);o.blitImage(s,f,u,_,p,0,!1)}else{if(!(c>=130&&c<=255))throw new Error("Unknown subencoding: "+c);var E=this._decodeRLEPaletteTile(c-128,h);o.blitImage(s,f,u,_,E,0,!1)}}return this._length=0,!0}},{key:"_getBitsPerPixelInPalette",value:function(e){return e<=2?1:e<=4?2:e<=16?4:void 0}},{key:"_readPixels",value:function(e){for(var t=this._pixelBuffer,r=this._inflator.inflate(3*e),i=0,n=0;i<4*e;i+=4,n+=3)t[i]=r[n],t[i+1]=r[n+1],t[i+2]=r[n+2],t[i+3]=255;return t}},{key:"_decodePaletteTile",value:function(e,t,r,i){for(var n=this._tileBuffer,o=this._readPixels(e),l=this._getBitsPerPixelInPalette(e),a=(1<<l)-1,f=0,_=this._inflator.inflate(1)[0],s=0;s<i;s++){for(var u=8-l,h=0;h<r;h++){u<0&&(u=8-l,_=this._inflator.inflate(1)[0]);var c=_>>u&a;n[f]=o[4*c],n[f+1]=o[4*c+1],n[f+2]=o[4*c+2],n[f+3]=o[4*c+3],f+=4,u-=l}u<8-l&&s<i-1&&(_=this._inflator.inflate(1)[0])}return n}},{key:"_decodeRLETile",value:function(e){for(var t=this._tileBuffer,r=0;r<e;)for(var i=this._readPixels(1),n=this._readRLELength(),o=0;o<n;o++)t[4*r]=i[0],t[4*r+1]=i[1],t[4*r+2]=i[2],t[4*r+3]=i[3],r++;return t}},{key:"_decodeRLEPaletteTile",value:function(e,t){for(var r=this._tileBuffer,i=this._readPixels(e),n=0;n<t;){var o=this._inflator.inflate(1)[0],l=1;if(o>=128&&(o-=128,l=this._readRLELength()),o>e)throw new Error("Too big index in palette: "+o+", palette size: "+e);if(n+l>t)throw new Error("Too big rle length in palette mode: "+l+", allowed length is: "+(t-n));for(var a=0;a<l;a++)r[4*n]=i[4*o],r[4*n+1]=i[4*o+1],r[4*n+2]=i[4*o+2],r[4*n+3]=i[4*o+3],n++}return r}},{key:"_readRLELength",value:function(){var e=0,t=0;do{e+=t=this._inflator.inflate(1)[0]}while(255===t);return e+1}}])}();
//# sourceMappingURL=/sm/c50395c7aa263f9cfd6c74ccc2099c81e198705b8c7f42906b09fedda8e5debe.map