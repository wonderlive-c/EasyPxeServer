/**
 * Minified by jsDelivr using Terser v5.37.0.
 * Original file: /npm/@novnc/novnc@1.6.0/lib/rfb.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _int=require("./util/int.js"),Log=_interopRequireWildcard(require("./util/logging.js")),_strings=require("./util/strings.js"),_browser=require("./util/browser.js"),_element=require("./util/element.js"),_events=require("./util/events.js"),_eventtarget=_interopRequireDefault(require("./util/eventtarget.js")),_display=_interopRequireDefault(require("./display.js")),_inflator=_interopRequireDefault(require("./inflator.js")),_deflator=_interopRequireDefault(require("./deflator.js")),_keyboard=_interopRequireDefault(require("./input/keyboard.js")),_gesturehandler=_interopRequireDefault(require("./input/gesturehandler.js")),_cursor=_interopRequireDefault(require("./util/cursor.js")),_websock=_interopRequireDefault(require("./websock.js")),_keysym=_interopRequireDefault(require("./input/keysym.js")),_xtscancodes=_interopRequireDefault(require("./input/xtscancodes.js")),_encodings=require("./encodings.js"),_ra=_interopRequireDefault(require("./ra2.js")),_crypto=_interopRequireDefault(require("./crypto/crypto.js")),_raw=_interopRequireDefault(require("./decoders/raw.js")),_copyrect=_interopRequireDefault(require("./decoders/copyrect.js")),_rre=_interopRequireDefault(require("./decoders/rre.js")),_hextile=_interopRequireDefault(require("./decoders/hextile.js")),_zlib=_interopRequireDefault(require("./decoders/zlib.js")),_tight=_interopRequireDefault(require("./decoders/tight.js")),_tightpng=_interopRequireDefault(require("./decoders/tightpng.js")),_zrle=_interopRequireDefault(require("./decoders/zrle.js")),_jpeg=_interopRequireDefault(require("./decoders/jpeg.js")),_h=_interopRequireDefault(require("./decoders/h264.js"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,s=new WeakMap;return(_getRequireWildcardCache=function(e){return e?s:t})(e)}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=_typeof(e)&&"function"!=typeof e)return{default:e};var s=_getRequireWildcardCache(t);if(s&&s.has(e))return s.get(e);var i={__proto__:null},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var r in e)if("default"!==r&&{}.hasOwnProperty.call(e,r)){var o=n?Object.getOwnPropertyDescriptor(e,r):null;o&&(o.get||o.set)?Object.defineProperty(i,r,o):i[r]=e[r]}return i.default=e,s&&s.set(e,i),i}function _regeneratorRuntime(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */_regeneratorRuntime=function(){return t};var e,t={},s=Object.prototype,i=s.hasOwnProperty,n=Object.defineProperty||function(e,t,s){e[t]=s.value},r="function"==typeof Symbol?Symbol:{},o=r.iterator||"@@iterator",a=r.asyncIterator||"@@asyncIterator",u=r.toStringTag||"@@toStringTag";function h(e,t,s){return Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{h({},"")}catch(e){h=function(e,t,s){return e[t]=s}}function c(e,t,s,i){var r=t&&t.prototype instanceof y?t:y,o=Object.create(r.prototype),a=new A(i||[]);return n(o,"_invoke",{value:x(e,s,a)}),o}function l(e,t,s){try{return{type:"normal",arg:e.call(t,s)}}catch(e){return{type:"throw",arg:e}}}t.wrap=c;var d="suspendedStart",_="suspendedYield",p="executing",f="completed",g={};function y(){}function v(){}function b(){}var k={};h(k,o,(function(){return this}));var m=Object.getPrototypeOf,S=m&&m(m(M([])));S&&S!==s&&i.call(S,o)&&(k=S);var w=b.prototype=y.prototype=Object.create(k);function C(e){["next","throw","return"].forEach((function(t){h(e,t,(function(e){return this._invoke(t,e)}))}))}function E(e,t){function s(n,r,o,a){var u=l(e[n],e,r);if("throw"!==u.type){var h=u.arg,c=h.value;return c&&"object"==_typeof(c)&&i.call(c,"__await")?t.resolve(c.__await).then((function(e){s("next",e,o,a)}),(function(e){s("throw",e,o,a)})):t.resolve(c).then((function(e){h.value=e,o(h)}),(function(e){return s("throw",e,o,a)}))}a(u.arg)}var r;n(this,"_invoke",{value:function(e,i){function n(){return new t((function(t,n){s(e,i,t,n)}))}return r=r?r.then(n,n):n()}})}function x(t,s,i){var n=d;return function(r,o){if(n===p)throw Error("Generator is already running");if(n===f){if("throw"===r)throw o;return{value:e,done:!0}}for(i.method=r,i.arg=o;;){var a=i.delegate;if(a){var u=L(a,i);if(u){if(u===g)continue;return u}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if(n===d)throw n=f,i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n=p;var h=l(t,s,i);if("normal"===h.type){if(n=i.done?f:_,h.arg===g)continue;return{value:h.arg,done:i.done}}"throw"===h.type&&(n=f,i.method="throw",i.arg=h.arg)}}}function L(t,s){var i=s.method,n=t.iterator[i];if(n===e)return s.delegate=null,"throw"===i&&t.iterator.return&&(s.method="return",s.arg=e,L(t,s),"throw"===s.method)||"return"!==i&&(s.method="throw",s.arg=new TypeError("The iterator does not provide a '"+i+"' method")),g;var r=l(n,t.iterator,s.arg);if("throw"===r.type)return s.method="throw",s.arg=r.arg,s.delegate=null,g;var o=r.arg;return o?o.done?(s[t.resultName]=o.value,s.next=t.nextLoc,"return"!==s.method&&(s.method="next",s.arg=e),s.delegate=null,g):o:(s.method="throw",s.arg=new TypeError("iterator result is not an object"),s.delegate=null,g)}function T(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function Q(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(T,this),this.reset(!0)}function M(t){if(t||""===t){var s=t[o];if(s)return s.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,r=function s(){for(;++n<t.length;)if(i.call(t,n))return s.value=t[n],s.done=!1,s;return s.value=e,s.done=!0,s};return r.next=r}}throw new TypeError(_typeof(t)+" is not iterable")}return v.prototype=b,n(w,"constructor",{value:b,configurable:!0}),n(b,"constructor",{value:v,configurable:!0}),v.displayName=h(b,u,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,h(e,u,"GeneratorFunction")),e.prototype=Object.create(w),e},t.awrap=function(e){return{__await:e}},C(E.prototype),h(E.prototype,a,(function(){return this})),t.AsyncIterator=E,t.async=function(e,s,i,n,r){void 0===r&&(r=Promise);var o=new E(c(e,s,i,n),r);return t.isGeneratorFunction(s)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},C(w),h(w,u,"Generator"),h(w,o,(function(){return this})),h(w,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),s=[];for(var i in t)s.push(i);return s.reverse(),function e(){for(;s.length;){var i=s.pop();if(i in t)return e.value=i,e.done=!1,e}return e.done=!0,e}},t.values=M,A.prototype={constructor:A,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(Q),!t)for(var s in this)"t"===s.charAt(0)&&i.call(this,s)&&!isNaN(+s.slice(1))&&(this[s]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var s=this;function n(i,n){return a.type="throw",a.arg=t,s.next=i,n&&(s.method="next",s.arg=e),!!n}for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r],a=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var u=i.call(o,"catchLoc"),h=i.call(o,"finallyLoc");if(u&&h){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(u){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!h)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var s=this.tryEntries.length-1;s>=0;--s){var n=this.tryEntries[s];if(n.tryLoc<=this.prev&&i.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var r=n;break}}r&&("break"===e||"continue"===e)&&r.tryLoc<=t&&t<=r.finallyLoc&&(r=null);var o=r?r.completion:{};return o.type=e,o.arg=t,r?(this.method="next",this.next=r.finallyLoc,g):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var s=this.tryEntries[t];if(s.finallyLoc===e)return this.complete(s.completion,s.afterLoc),Q(s),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var s=this.tryEntries[t];if(s.tryLoc===e){var i=s.completion;if("throw"===i.type){var n=i.arg;Q(s)}return n}}throw Error("illegal catch attempt")},delegateYield:function(t,s,i){return this.delegate={iterator:M(t),resultName:s,nextLoc:i},"next"===this.method&&(this.arg=e),g}},t}function asyncGeneratorStep(e,t,s,i,n,r,o){try{var a=e[r](o),u=a.value}catch(e){return void s(e)}a.done?t(u):Promise.resolve(u).then(i,n)}function _asyncToGenerator(e){return function(){var t=this,s=arguments;return new Promise((function(i,n){var r=e.apply(t,s);function o(e){asyncGeneratorStep(r,i,n,o,a,"next",e)}function a(e){asyncGeneratorStep(r,i,n,o,a,"throw",e)}o(void 0)}))}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var s=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=s){var i,n,r,o,a=[],u=!0,h=!1;try{if(r=(s=s.call(e)).next,0===t){if(Object(s)!==s)return;u=!1}else for(;!(u=(i=r.call(s)).done)&&(a.push(i.value),a.length!==t);u=!0);}catch(e){h=!0,n=e}finally{try{if(!u&&null!=s.return&&(o=s.return(),Object(o)!==o))return}finally{if(h)throw n}}return a}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _createForOfIteratorHelper(e,t){var s="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!s){if(Array.isArray(e)||(s=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){s&&(e=s);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o=!0,a=!1;return{s:function(){s=s.call(e)},n:function(){var e=s.next();return o=e.done,e},e:function(e){a=!0,r=e},f:function(){try{o||null==s.return||s.return()}finally{if(a)throw r}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var s={}.toString.call(e).slice(8,-1);return"Object"===s&&e.constructor&&(s=e.constructor.name),"Map"===s||"Set"===s?Array.from(e):"Arguments"===s||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var s=0,i=Array(t);s<t;s++)i[s]=e[s];return i}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,t,s){return t&&_defineProperties(e.prototype,t),s&&_defineProperties(e,s),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var i=s.call(e,t||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function _callSuper(e,t,s){return t=_getPrototypeOf(t),_possibleConstructorReturn(e,_isNativeReflectConstruct()?Reflect.construct(t,s||[],_getPrototypeOf(e).constructor):t.apply(e,s))}function _possibleConstructorReturn(e,t){if(t&&("object"==_typeof(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(_isNativeReflectConstruct=function(){return!!e})()}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}var DISCONNECT_TIMEOUT=3,DEFAULT_BACKGROUND="rgb(40, 40, 40)",MOUSE_MOVE_DELAY=17,WHEEL_STEP=50,WHEEL_LINE_HEIGHT=19,GESTURE_ZOOMSENS=75,GESTURE_SCRLSENS=50,DOUBLE_TAP_TIMEOUT=1e3,DOUBLE_TAP_THRESHOLD=50,securityTypeNone=1,securityTypeVNCAuth=2,securityTypeRA2ne=6,securityTypeTight=16,securityTypeVeNCrypt=19,securityTypeXVP=22,securityTypeARD=30,securityTypeMSLogonII=113,securityTypeUnixLogon=129,securityTypePlain=256,extendedClipboardFormatText=1,extendedClipboardFormatRtf=2,extendedClipboardFormatHtml=4,extendedClipboardFormatDib=8,extendedClipboardFormatFiles=16,extendedClipboardActionCaps=1<<24,extendedClipboardActionRequest=1<<25,extendedClipboardActionPeek=1<<26,extendedClipboardActionNotify=1<<27,extendedClipboardActionProvide=1<<28,RFB=exports.default=function(){function e(t,s,i){var n;if(_classCallCheck(this,e),!t)throw new Error("Must specify target");if(!s)throw new Error("Must specify URL, WebSocket or RTCDataChannel");window.isSecureContext||Log.Error("noVNC requires a secure context (TLS). Expect crashes!"),(n=_callSuper(this,e))._target=t,"string"==typeof s?n._url=s:(n._url=null,n._rawChannel=s),i=i||{},n._rfbCredentials=i.credentials||{},n._shared=!("shared"in i)||!!i.shared,n._repeaterID=i.repeaterID||"",n._wsProtocols=i.wsProtocols||[],n._rfbConnectionState="",n._rfbInitState="",n._rfbAuthScheme=-1,n._rfbCleanDisconnect=!0,n._rfbRSAAESAuthenticationState=null,n._rfbVersion=0,n._rfbMaxVersion=3.8,n._rfbTightVNC=!1,n._rfbVeNCryptState=0,n._rfbXvpVer=0,n._fbWidth=0,n._fbHeight=0,n._fbName="",n._capabilities={power:!1},n._supportsFence=!1,n._supportsContinuousUpdates=!1,n._enabledContinuousUpdates=!1,n._supportsSetDesktopSize=!1,n._screenID=0,n._screenFlags=0,n._pendingRemoteResize=!1,n._lastResize=0,n._qemuExtKeyEventSupported=!1,n._extendedPointerEventSupported=!1,n._clipboardText=null,n._clipboardServerCapabilitiesActions={},n._clipboardServerCapabilitiesFormats={},n._sock=null,n._display=null,n._flushing=!1,n._keyboard=null,n._gestures=null,n._resizeObserver=null,n._disconnTimer=null,n._resizeTimeout=null,n._mouseMoveTimer=null,n._decoders={},n._FBU={rects:0,x:0,y:0,width:0,height:0,encoding:null},n._mousePos={},n._mouseButtonMask=0,n._mouseLastMoveTime=0,n._viewportDragging=!1,n._viewportDragPos={},n._viewportHasMoved=!1,n._accumulatedWheelDeltaX=0,n._accumulatedWheelDeltaY=0,n._gestureLastTapTime=null,n._gestureFirstDoubleTapEv=null,n._gestureLastMagnitudeX=0,n._gestureLastMagnitudeY=0,n._eventHandlers={focusCanvas:n._focusCanvas.bind(n),handleResize:n._handleResize.bind(n),handleMouse:n._handleMouse.bind(n),handleWheel:n._handleWheel.bind(n),handleGesture:n._handleGesture.bind(n),handleRSAAESCredentialsRequired:n._handleRSAAESCredentialsRequired.bind(n),handleRSAAESServerVerification:n._handleRSAAESServerVerification.bind(n)},Log.Debug(">> RFB.constructor"),n._screen=document.createElement("div"),n._screen.style.display="flex",n._screen.style.width="100%",n._screen.style.height="100%",n._screen.style.overflow="auto",n._screen.style.background=DEFAULT_BACKGROUND,n._canvas=document.createElement("canvas"),n._canvas.style.margin="auto",n._canvas.style.outline="none",n._canvas.width=0,n._canvas.height=0,n._canvas.tabIndex=-1,n._screen.appendChild(n._canvas),n._cursor=new _cursor.default,n._cursorImage=e.cursors.none,n._decoders[_encodings.encodings.encodingRaw]=new _raw.default,n._decoders[_encodings.encodings.encodingCopyRect]=new _copyrect.default,n._decoders[_encodings.encodings.encodingRRE]=new _rre.default,n._decoders[_encodings.encodings.encodingHextile]=new _hextile.default,n._decoders[_encodings.encodings.encodingZlib]=new _zlib.default,n._decoders[_encodings.encodings.encodingTight]=new _tight.default,n._decoders[_encodings.encodings.encodingTightPNG]=new _tightpng.default,n._decoders[_encodings.encodings.encodingZRLE]=new _zrle.default,n._decoders[_encodings.encodings.encodingJPEG]=new _jpeg.default,n._decoders[_encodings.encodings.encodingH264]=new _h.default;try{n._display=new _display.default(n._canvas)}catch(e){throw Log.Error("Display exception: "+e),e}return n._keyboard=new _keyboard.default(n._canvas),n._keyboard.onkeyevent=n._handleKeyEvent.bind(n),n._remoteCapsLock=null,n._remoteNumLock=null,n._gestures=new _gesturehandler.default,n._sock=new _websock.default,n._sock.on("open",n._socketOpen.bind(n)),n._sock.on("close",n._socketClose.bind(n)),n._sock.on("message",n._handleMessage.bind(n)),n._sock.on("error",n._socketError.bind(n)),n._expectedClientWidth=null,n._expectedClientHeight=null,n._resizeObserver=new ResizeObserver(n._eventHandlers.handleResize),n._updateConnectionState("connecting"),Log.Debug("<< RFB.constructor"),n.dragViewport=!1,n.focusOnClick=!0,n._viewOnly=!1,n._clipViewport=!1,n._clippingViewport=!1,n._scaleViewport=!1,n._resizeSession=!1,n._showDotCursor=!1,void 0!==i.showDotCursor&&(Log.Warn("Specifying showDotCursor as a RFB constructor argument is deprecated"),n._showDotCursor=i.showDotCursor),n._qualityLevel=6,n._compressionLevel=2,n}return _inherits(e,_eventtarget["default"]),_createClass(e,[{key:"viewOnly",get:function(){return this._viewOnly},set:function(e){this._viewOnly=e,"connecting"!==this._rfbConnectionState&&"connected"!==this._rfbConnectionState||(e?this._keyboard.ungrab():this._keyboard.grab())}},{key:"capabilities",get:function(){return this._capabilities}},{key:"clippingViewport",get:function(){return this._clippingViewport}},{key:"_setClippingViewport",value:function(e){e!==this._clippingViewport&&(this._clippingViewport=e,this.dispatchEvent(new CustomEvent("clippingviewport",{detail:this._clippingViewport})))}},{key:"touchButton",get:function(){return 0},set:function(e){Log.Warn("Using old API!")}},{key:"clipViewport",get:function(){return this._clipViewport},set:function(e){this._clipViewport=e,this._updateClip()}},{key:"scaleViewport",get:function(){return this._scaleViewport},set:function(e){this._scaleViewport=e,e&&this._clipViewport&&this._updateClip(),this._updateScale(),!e&&this._clipViewport&&this._updateClip()}},{key:"resizeSession",get:function(){return this._resizeSession},set:function(e){this._resizeSession=e,e&&this._requestRemoteResize()}},{key:"showDotCursor",get:function(){return this._showDotCursor},set:function(e){this._showDotCursor=e,this._refreshCursor()}},{key:"background",get:function(){return this._screen.style.background},set:function(e){this._screen.style.background=e}},{key:"qualityLevel",get:function(){return this._qualityLevel},set:function(e){!Number.isInteger(e)||e<0||e>9?Log.Error("qualityLevel must be an integer between 0 and 9"):this._qualityLevel!==e&&(this._qualityLevel=e,"connected"===this._rfbConnectionState&&this._sendEncodings())}},{key:"compressionLevel",get:function(){return this._compressionLevel},set:function(e){!Number.isInteger(e)||e<0||e>9?Log.Error("compressionLevel must be an integer between 0 and 9"):this._compressionLevel!==e&&(this._compressionLevel=e,"connected"===this._rfbConnectionState&&this._sendEncodings())}},{key:"disconnect",value:function(){this._updateConnectionState("disconnecting"),this._sock.off("error"),this._sock.off("message"),this._sock.off("open"),null!==this._rfbRSAAESAuthenticationState&&this._rfbRSAAESAuthenticationState.disconnect()}},{key:"approveServer",value:function(){null!==this._rfbRSAAESAuthenticationState&&this._rfbRSAAESAuthenticationState.approveServer()}},{key:"sendCredentials",value:function(e){this._rfbCredentials=e,this._resumeAuthentication()}},{key:"sendCtrlAltDel",value:function(){"connected"!==this._rfbConnectionState||this._viewOnly||(Log.Info("Sending Ctrl-Alt-Del"),this.sendKey(_keysym.default.XK_Control_L,"ControlLeft",!0),this.sendKey(_keysym.default.XK_Alt_L,"AltLeft",!0),this.sendKey(_keysym.default.XK_Delete,"Delete",!0),this.sendKey(_keysym.default.XK_Delete,"Delete",!1),this.sendKey(_keysym.default.XK_Alt_L,"AltLeft",!1),this.sendKey(_keysym.default.XK_Control_L,"ControlLeft",!1))}},{key:"machineShutdown",value:function(){this._xvpOp(1,2)}},{key:"machineReboot",value:function(){this._xvpOp(1,3)}},{key:"machineReset",value:function(){this._xvpOp(1,4)}},{key:"sendKey",value:function(t,s,i){if("connected"===this._rfbConnectionState&&!this._viewOnly){if(void 0===i)return this.sendKey(t,s,!0),void this.sendKey(t,s,!1);var n=_xtscancodes.default[s];if(this._qemuExtKeyEventSupported&&n)t=t||0,Log.Info("Sending key ("+(i?"down":"up")+"): keysym "+t+", scancode "+n),e.messages.QEMUExtendedKeyEvent(this._sock,t,i,n);else{if(!t)return;Log.Info("Sending keysym ("+(i?"down":"up")+"): "+t),e.messages.keyEvent(this._sock,t,i?1:0)}}}},{key:"focus",value:function(e){this._canvas.focus(e)}},{key:"blur",value:function(){this._canvas.blur()}},{key:"clipboardPasteFrom",value:function(t){if("connected"===this._rfbConnectionState&&!this._viewOnly)if(this._clipboardServerCapabilitiesFormats[extendedClipboardFormatText]&&this._clipboardServerCapabilitiesActions[extendedClipboardActionNotify])this._clipboardText=t,e.messages.extendedClipboardNotify(this._sock,[extendedClipboardFormatText]);else{var s,i,n;s=0;var r,o=_createForOfIteratorHelper(t);try{for(o.s();!(r=o.n()).done;){r.value;s++}}catch(e){o.e(e)}finally{o.f()}n=new Uint8Array(s),i=0;var a,u=_createForOfIteratorHelper(t);try{for(u.s();!(a=u.n()).done;){var h=a.value.codePointAt(0);h>255&&(h=63),n[i++]=h}}catch(e){u.e(e)}finally{u.f()}e.messages.clientCutText(this._sock,n)}}},{key:"getImageData",value:function(){return this._display.getImageData()}},{key:"toDataURL",value:function(e,t){return this._display.toDataURL(e,t)}},{key:"toBlob",value:function(e,t,s){return this._display.toBlob(e,t,s)}},{key:"_connect",value:function(){if(Log.Debug(">> RFB.connect"),this._url)Log.Info("connecting to ".concat(this._url)),this._sock.open(this._url,this._wsProtocols);else{if(Log.Info("attaching ".concat(this._rawChannel," to Websock")),this._sock.attach(this._rawChannel),"closed"===this._sock.readyState)throw Error("Cannot use already closed WebSocket/RTCDataChannel");"open"===this._sock.readyState&&this._socketOpen()}this._target.appendChild(this._screen),this._gestures.attach(this._canvas),this._cursor.attach(this._canvas),this._refreshCursor(),this._resizeObserver.observe(this._screen),this._canvas.addEventListener("mousedown",this._eventHandlers.focusCanvas),this._canvas.addEventListener("touchstart",this._eventHandlers.focusCanvas),this._canvas.addEventListener("mousedown",this._eventHandlers.handleMouse),this._canvas.addEventListener("mouseup",this._eventHandlers.handleMouse),this._canvas.addEventListener("mousemove",this._eventHandlers.handleMouse),this._canvas.addEventListener("click",this._eventHandlers.handleMouse),this._canvas.addEventListener("contextmenu",this._eventHandlers.handleMouse),this._canvas.addEventListener("wheel",this._eventHandlers.handleWheel),this._canvas.addEventListener("gesturestart",this._eventHandlers.handleGesture),this._canvas.addEventListener("gesturemove",this._eventHandlers.handleGesture),this._canvas.addEventListener("gestureend",this._eventHandlers.handleGesture),Log.Debug("<< RFB.connect")}},{key:"_disconnect",value:function(){Log.Debug(">> RFB.disconnect"),this._cursor.detach(),this._canvas.removeEventListener("gesturestart",this._eventHandlers.handleGesture),this._canvas.removeEventListener("gesturemove",this._eventHandlers.handleGesture),this._canvas.removeEventListener("gestureend",this._eventHandlers.handleGesture),this._canvas.removeEventListener("wheel",this._eventHandlers.handleWheel),this._canvas.removeEventListener("mousedown",this._eventHandlers.handleMouse),this._canvas.removeEventListener("mouseup",this._eventHandlers.handleMouse),this._canvas.removeEventListener("mousemove",this._eventHandlers.handleMouse),this._canvas.removeEventListener("click",this._eventHandlers.handleMouse),this._canvas.removeEventListener("contextmenu",this._eventHandlers.handleMouse),this._canvas.removeEventListener("mousedown",this._eventHandlers.focusCanvas),this._canvas.removeEventListener("touchstart",this._eventHandlers.focusCanvas),this._resizeObserver.disconnect(),this._keyboard.ungrab(),this._gestures.detach(),this._sock.close();try{this._target.removeChild(this._screen)}catch(e){if("NotFoundError"!==e.name)throw e}clearTimeout(this._resizeTimeout),clearTimeout(this._mouseMoveTimer),Log.Debug("<< RFB.disconnect")}},{key:"_socketOpen",value:function(){"connecting"===this._rfbConnectionState&&""===this._rfbInitState?(this._rfbInitState="ProtocolVersion",Log.Debug("Starting VNC handshake")):this._fail("Unexpected server connection while "+this._rfbConnectionState)}},{key:"_socketClose",value:function(e){Log.Debug("WebSocket on-close event");var t="";switch(e.code&&(t="(code: "+e.code,e.reason&&(t+=", reason: "+e.reason),t+=")"),this._rfbConnectionState){case"connecting":this._fail("Connection closed "+t);break;case"connected":this._updateConnectionState("disconnecting"),this._updateConnectionState("disconnected");break;case"disconnecting":this._updateConnectionState("disconnected");break;case"disconnected":this._fail("Unexpected server disconnect when already disconnected "+t);break;default:this._fail("Unexpected server disconnect before connecting "+t)}this._sock.off("close"),this._rawChannel=null}},{key:"_socketError",value:function(e){Log.Warn("WebSocket on-error event")}},{key:"_focusCanvas",value:function(e){this.focusOnClick&&this.focus({preventScroll:!0})}},{key:"_setDesktopName",value:function(e){this._fbName=e,this.dispatchEvent(new CustomEvent("desktopname",{detail:{name:this._fbName}}))}},{key:"_saveExpectedClientSize",value:function(){this._expectedClientWidth=this._screen.clientWidth,this._expectedClientHeight=this._screen.clientHeight}},{key:"_currentClientSize",value:function(){return[this._screen.clientWidth,this._screen.clientHeight]}},{key:"_clientHasExpectedSize",value:function(){var e=_slicedToArray(this._currentClientSize(),2),t=e[0],s=e[1];return t==this._expectedClientWidth&&s==this._expectedClientHeight}},{key:"_handleResize",value:function(){var e=this;this._clientHasExpectedSize()||(window.requestAnimationFrame((function(){e._updateClip(),e._updateScale(),e._saveExpectedClientSize()})),this._requestRemoteResize())}},{key:"_updateClip",value:function(){var e=this._display.clipViewport,t=this._clipViewport;if(this._scaleViewport&&(t=!1),e!==t&&(this._display.clipViewport=t),t){var s=this._screenSize();this._display.viewportChangeSize(s.w,s.h),this._fixScrollbars(),this._setClippingViewport(s.w<this._display.width||s.h<this._display.height)}else this._setClippingViewport(!1);e!==t&&this._saveExpectedClientSize()}},{key:"_updateScale",value:function(){if(this._scaleViewport){var e=this._screenSize();this._display.autoscale(e.w,e.h)}else this._display.scale=1;this._fixScrollbars()}},{key:"_requestRemoteResize",value:function(){if(this._resizeSession&&!this._viewOnly&&this._supportsSetDesktopSize&&!this._pendingRemoteResize){if(Date.now()-this._lastResize<100)return clearTimeout(this._resizeTimeout),void(this._resizeTimeout=setTimeout(this._requestRemoteResize.bind(this),100-(Date.now()-this._lastResize)));this._resizeTimeout=null;var t=this._screenSize();t.w===this._fbWidth&&t.h===this._fbHeight||(this._pendingRemoteResize=!0,this._lastResize=Date.now(),e.messages.setDesktopSize(this._sock,Math.floor(t.w),Math.floor(t.h),this._screenID,this._screenFlags),Log.Debug("Requested new desktop size: "+t.w+"x"+t.h))}}},{key:"_screenSize",value:function(){var e=this._screen.getBoundingClientRect();return{w:e.width,h:e.height}}},{key:"_fixScrollbars",value:function(){var e=this._screen.style.overflow;this._screen.style.overflow="hidden",this._screen.getBoundingClientRect(),this._screen.style.overflow=e}},{key:"_updateConnectionState",value:function(e){var t=this,s=this._rfbConnectionState;if(e!==s)if("disconnected"!==s){switch(e){case"connected":if("connecting"!==s)return void Log.Error("Bad transition to connected state, previous connection state: "+s);break;case"disconnected":if("disconnecting"!==s)return void Log.Error("Bad transition to disconnected state, previous connection state: "+s);break;case"connecting":if(""!==s)return void Log.Error("Bad transition to connecting state, previous connection state: "+s);break;case"disconnecting":if("connected"!==s&&"connecting"!==s)return void Log.Error("Bad transition to disconnecting state, previous connection state: "+s);break;default:return void Log.Error("Unknown connection state: "+e)}switch(this._rfbConnectionState=e,Log.Debug("New state '"+e+"', was '"+s+"'."),this._disconnTimer&&"disconnecting"!==e&&(Log.Debug("Clearing disconnect timer"),clearTimeout(this._disconnTimer),this._disconnTimer=null,this._sock.off("close")),e){case"connecting":this._connect();break;case"connected":this.dispatchEvent(new CustomEvent("connect",{detail:{}}));break;case"disconnecting":this._disconnect(),this._disconnTimer=setTimeout((function(){Log.Error("Disconnection timed out."),t._updateConnectionState("disconnected")}),1e3*DISCONNECT_TIMEOUT);break;case"disconnected":this.dispatchEvent(new CustomEvent("disconnect",{detail:{clean:this._rfbCleanDisconnect}}))}}else Log.Error("Tried changing state of a disconnected RFB object");else Log.Debug("Already in state '"+e+"', ignoring")}},{key:"_fail",value:function(e){switch(this._rfbConnectionState){case"disconnecting":Log.Error("Failed when disconnecting: "+e);break;case"connected":Log.Error("Failed while connected: "+e);break;case"connecting":Log.Error("Failed when connecting: "+e);break;default:Log.Error("RFB failure: "+e)}return this._rfbCleanDisconnect=!1,this._updateConnectionState("disconnecting"),this._updateConnectionState("disconnected"),!1}},{key:"_setCapability",value:function(e,t){this._capabilities[e]=t,this.dispatchEvent(new CustomEvent("capabilities",{detail:{capabilities:this._capabilities}}))}},{key:"_handleMessage",value:function(){if(this._sock.rQwait("message",1))Log.Warn("handleMessage called on an empty receive queue");else switch(this._rfbConnectionState){case"disconnected":Log.Error("Got data while disconnected");break;case"connected":for(;!this._flushing&&this._normalMsg()&&!this._sock.rQwait("message",1););break;case"connecting":for(;"connecting"===this._rfbConnectionState&&this._initMsg(););break;default:Log.Error("Got data while in an invalid state")}}},{key:"_handleKeyEvent",value:function(e,t,s,i,n){"CapsLock"==t&&s&&(this._remoteCapsLock=null),null!==this._remoteCapsLock&&null!==n&&this._remoteCapsLock!==n&&s&&(Log.Debug("Fixing remote caps lock"),this.sendKey(_keysym.default.XK_Caps_Lock,"CapsLock",!0),this.sendKey(_keysym.default.XK_Caps_Lock,"CapsLock",!1),this._remoteCapsLock=null),"NumLock"==t&&s&&(this._remoteNumLock=null),null!==this._remoteNumLock&&null!==i&&this._remoteNumLock!==i&&s&&(Log.Debug("Fixing remote num lock"),this.sendKey(_keysym.default.XK_Num_Lock,"NumLock",!0),this.sendKey(_keysym.default.XK_Num_Lock,"NumLock",!1),this._remoteNumLock=null),this.sendKey(e,t,s)}},{key:"_handleMouse",value:function(t){if(("click"!==t.type||t.target===this._canvas)&&(t.stopPropagation(),t.preventDefault(),"click"!==t.type&&"contextmenu"!==t.type)){var s=(0,_element.clientToElement)(t.clientX,t.clientY,this._canvas),i=e._convertButtonMask(t.buttons),n="mousedown"==t.type;switch(t.type){case"mousedown":case"mouseup":if(this.dragViewport){if(n&&!this._viewportDragging){this._viewportDragging=!0,this._viewportDragPos={x:s.x,y:s.y},this._viewportHasMoved=!1,this._flushMouseMoveTimer(s.x,s.y),this._mouseButtonMask=i;break}if(this._viewportDragging=!1,this._viewportHasMoved){this._mouseButtonMask=i;break}this._sendMouse(s.x,s.y,this._mouseButtonMask)}n&&(0,_events.setCapture)(this._canvas),this._handleMouseButton(s.x,s.y,i);break;case"mousemove":if(this._viewportDragging){var r=this._viewportDragPos.x-s.x,o=this._viewportDragPos.y-s.y;(this._viewportHasMoved||Math.abs(r)>_browser.dragThreshold||Math.abs(o)>_browser.dragThreshold)&&(this._viewportHasMoved=!0,this._viewportDragPos={x:s.x,y:s.y},this._display.viewportChangePos(r,o));break}this._handleMouseMove(s.x,s.y)}}}},{key:"_handleMouseButton",value:function(e,t,s){this._flushMouseMoveTimer(e,t),this._mouseButtonMask=s,this._sendMouse(e,t,this._mouseButtonMask)}},{key:"_handleMouseMove",value:function(e,t){var s=this;if(this._mousePos={x:e,y:t},null==this._mouseMoveTimer){var i=Date.now()-this._mouseLastMoveTime;i>MOUSE_MOVE_DELAY?(this._sendMouse(e,t,this._mouseButtonMask),this._mouseLastMoveTime=Date.now()):this._mouseMoveTimer=setTimeout((function(){s._handleDelayedMouseMove()}),MOUSE_MOVE_DELAY-i)}}},{key:"_handleDelayedMouseMove",value:function(){this._mouseMoveTimer=null,this._sendMouse(this._mousePos.x,this._mousePos.y,this._mouseButtonMask),this._mouseLastMoveTime=Date.now()}},{key:"_sendMouse",value:function(t,s,i){if("connected"===this._rfbConnectionState&&!this._viewOnly){if(32768&i)throw new Error("Illegal mouse button mask (mask: "+i+")");var n=32640&i;this._extendedPointerEventSupported&&n?e.messages.extendedPointerEvent(this._sock,this._display.absX(t),this._display.absY(s),i):e.messages.pointerEvent(this._sock,this._display.absX(t),this._display.absY(s),i)}}},{key:"_handleWheel",value:function(t){if("connected"===this._rfbConnectionState&&!this._viewOnly){t.stopPropagation(),t.preventDefault();var s=(0,_element.clientToElement)(t.clientX,t.clientY,this._canvas),i=e._convertButtonMask(t.buttons),n=t.deltaX,r=t.deltaY;0!==t.deltaMode&&(n*=WHEEL_LINE_HEIGHT,r*=WHEEL_LINE_HEIGHT),this._accumulatedWheelDeltaX+=n,this._accumulatedWheelDeltaY+=r,Math.abs(this._accumulatedWheelDeltaX)>=WHEEL_STEP&&(this._accumulatedWheelDeltaX<0?(this._handleMouseButton(s.x,s.y,32|i),this._handleMouseButton(s.x,s.y,i)):this._accumulatedWheelDeltaX>0&&(this._handleMouseButton(s.x,s.y,64|i),this._handleMouseButton(s.x,s.y,i)),this._accumulatedWheelDeltaX=0),Math.abs(this._accumulatedWheelDeltaY)>=WHEEL_STEP&&(this._accumulatedWheelDeltaY<0?(this._handleMouseButton(s.x,s.y,8|i),this._handleMouseButton(s.x,s.y,i)):this._accumulatedWheelDeltaY>0&&(this._handleMouseButton(s.x,s.y,16|i),this._handleMouseButton(s.x,s.y,i)),this._accumulatedWheelDeltaY=0)}}},{key:"_fakeMouseMove",value:function(e,t,s){this._handleMouseMove(t,s),this._cursor.move(e.detail.clientX,e.detail.clientY)}},{key:"_handleTapEvent",value:function(e,t){var s=(0,_element.clientToElement)(e.detail.clientX,e.detail.clientY,this._canvas);if(null!==this._gestureLastTapTime&&Date.now()-this._gestureLastTapTime<DOUBLE_TAP_TIMEOUT&&this._gestureFirstDoubleTapEv.detail.type===e.detail.type){var i=this._gestureFirstDoubleTapEv.detail.clientX-e.detail.clientX,n=this._gestureFirstDoubleTapEv.detail.clientY-e.detail.clientY;Math.hypot(i,n)<DOUBLE_TAP_THRESHOLD?s=(0,_element.clientToElement)(this._gestureFirstDoubleTapEv.detail.clientX,this._gestureFirstDoubleTapEv.detail.clientY,this._canvas):this._gestureFirstDoubleTapEv=e}else this._gestureFirstDoubleTapEv=e;this._gestureLastTapTime=Date.now(),this._fakeMouseMove(this._gestureFirstDoubleTapEv,s.x,s.y),this._handleMouseButton(s.x,s.y,t),this._handleMouseButton(s.x,s.y,0)}},{key:"_handleGesture",value:function(e){var t,s=(0,_element.clientToElement)(e.detail.clientX,e.detail.clientY,this._canvas);switch(e.type){case"gesturestart":switch(e.detail.type){case"onetap":this._handleTapEvent(e,1);break;case"twotap":this._handleTapEvent(e,4);break;case"threetap":this._handleTapEvent(e,2);break;case"drag":this.dragViewport?(this._viewportHasMoved=!1,this._viewportDragging=!0,this._viewportDragPos={x:s.x,y:s.y}):(this._fakeMouseMove(e,s.x,s.y),this._handleMouseButton(s.x,s.y,1));break;case"longpress":this.dragViewport?(this._viewportHasMoved=!1,this._viewportDragPos={x:s.x,y:s.y}):(this._fakeMouseMove(e,s.x,s.y),this._handleMouseButton(s.x,s.y,4));break;case"twodrag":this._gestureLastMagnitudeX=e.detail.magnitudeX,this._gestureLastMagnitudeY=e.detail.magnitudeY,this._fakeMouseMove(e,s.x,s.y);break;case"pinch":this._gestureLastMagnitudeX=Math.hypot(e.detail.magnitudeX,e.detail.magnitudeY),this._fakeMouseMove(e,s.x,s.y)}break;case"gesturemove":switch(e.detail.type){case"onetap":case"twotap":case"threetap":break;case"drag":case"longpress":if(this.dragViewport){this._viewportDragging=!0;var i=this._viewportDragPos.x-s.x,n=this._viewportDragPos.y-s.y;(this._viewportHasMoved||Math.abs(i)>_browser.dragThreshold||Math.abs(n)>_browser.dragThreshold)&&(this._viewportHasMoved=!0,this._viewportDragPos={x:s.x,y:s.y},this._display.viewportChangePos(i,n))}else this._fakeMouseMove(e,s.x,s.y);break;case"twodrag":for(this._fakeMouseMove(e,s.x,s.y);e.detail.magnitudeY-this._gestureLastMagnitudeY>GESTURE_SCRLSENS;)this._handleMouseButton(s.x,s.y,8),this._handleMouseButton(s.x,s.y,0),this._gestureLastMagnitudeY+=GESTURE_SCRLSENS;for(;e.detail.magnitudeY-this._gestureLastMagnitudeY<-GESTURE_SCRLSENS;)this._handleMouseButton(s.x,s.y,16),this._handleMouseButton(s.x,s.y,0),this._gestureLastMagnitudeY-=GESTURE_SCRLSENS;for(;e.detail.magnitudeX-this._gestureLastMagnitudeX>GESTURE_SCRLSENS;)this._handleMouseButton(s.x,s.y,32),this._handleMouseButton(s.x,s.y,0),this._gestureLastMagnitudeX+=GESTURE_SCRLSENS;for(;e.detail.magnitudeX-this._gestureLastMagnitudeX<-GESTURE_SCRLSENS;)this._handleMouseButton(s.x,s.y,64),this._handleMouseButton(s.x,s.y,0),this._gestureLastMagnitudeX-=GESTURE_SCRLSENS;break;case"pinch":if(this._fakeMouseMove(e,s.x,s.y),t=Math.hypot(e.detail.magnitudeX,e.detail.magnitudeY),Math.abs(t-this._gestureLastMagnitudeX)>GESTURE_ZOOMSENS){for(this._handleKeyEvent(_keysym.default.XK_Control_L,"ControlLeft",!0);t-this._gestureLastMagnitudeX>GESTURE_ZOOMSENS;)this._handleMouseButton(s.x,s.y,8),this._handleMouseButton(s.x,s.y,0),this._gestureLastMagnitudeX+=GESTURE_ZOOMSENS;for(;t-this._gestureLastMagnitudeX<-GESTURE_ZOOMSENS;)this._handleMouseButton(s.x,s.y,16),this._handleMouseButton(s.x,s.y,0),this._gestureLastMagnitudeX-=GESTURE_ZOOMSENS}this._handleKeyEvent(_keysym.default.XK_Control_L,"ControlLeft",!1)}break;case"gestureend":switch(e.detail.type){case"onetap":case"twotap":case"threetap":case"pinch":case"twodrag":break;case"drag":this.dragViewport?this._viewportDragging=!1:(this._fakeMouseMove(e,s.x,s.y),this._handleMouseButton(s.x,s.y,0));break;case"longpress":if(this._viewportHasMoved)break;this.dragViewport&&!this._viewportHasMoved?(this._fakeMouseMove(e,s.x,s.y),this._handleMouseButton(s.x,s.y,4),this._handleMouseButton(s.x,s.y,0),this._viewportDragging=!1):(this._fakeMouseMove(e,s.x,s.y),this._handleMouseButton(s.x,s.y,0))}}}},{key:"_flushMouseMoveTimer",value:function(e,t){null!==this._mouseMoveTimer&&(clearTimeout(this._mouseMoveTimer),this._mouseMoveTimer=null,this._sendMouse(e,t,this._mouseButtonMask))}},{key:"_negotiateProtocolVersion",value:function(){if(this._sock.rQwait("version",12))return!1;var e=this._sock.rQshiftStr(12).substr(4,7);Log.Info("Server ProtocolVersion: "+e);var t=0;switch(e){case"000.000":t=1;break;case"003.003":case"003.006":this._rfbVersion=3.3;break;case"003.007":this._rfbVersion=3.7;break;case"003.008":case"003.889":case"004.000":case"004.001":case"005.000":this._rfbVersion=3.8;break;default:return this._fail("Invalid server version "+e)}if(t){for(var s="ID:"+this._repeaterID;s.length<250;)s+="\0";return this._sock.sQpushString(s),this._sock.flush(),!0}this._rfbVersion>this._rfbMaxVersion&&(this._rfbVersion=this._rfbMaxVersion);var i="00"+parseInt(this._rfbVersion,10)+".00"+10*this._rfbVersion%10;this._sock.sQpushString("RFB "+i+"\n"),this._sock.flush(),Log.Debug("Sent ProtocolVersion: "+i),this._rfbInitState="Security"}},{key:"_isSupportedSecurityType",value:function(e){return[securityTypeNone,securityTypeVNCAuth,securityTypeRA2ne,securityTypeTight,securityTypeVeNCrypt,securityTypeXVP,securityTypeARD,securityTypeMSLogonII,securityTypePlain].includes(e)}},{key:"_negotiateSecurity",value:function(){if(this._rfbVersion>=3.7){var e=this._sock.rQshift8();if(this._sock.rQwait("security type",e,1))return!1;if(0===e)return this._rfbInitState="SecurityReason",this._securityContext="no security types",this._securityStatus=1,!0;var t=this._sock.rQshiftBytes(e);Log.Debug("Server security types: "+t),this._rfbAuthScheme=-1;var s,i=_createForOfIteratorHelper(t);try{for(i.s();!(s=i.n()).done;){var n=s.value;if(this._isSupportedSecurityType(n)){this._rfbAuthScheme=n;break}}}catch(e){i.e(e)}finally{i.f()}if(-1===this._rfbAuthScheme)return this._fail("Unsupported security types (types: "+t+")");this._sock.sQpush8(this._rfbAuthScheme),this._sock.flush()}else{if(this._sock.rQwait("security scheme",4))return!1;if(this._rfbAuthScheme=this._sock.rQshift32(),0==this._rfbAuthScheme)return this._rfbInitState="SecurityReason",this._securityContext="authentication scheme",this._securityStatus=1,!0}return this._rfbInitState="Authentication",Log.Debug("Authenticating using scheme: "+this._rfbAuthScheme),!0}},{key:"_handleSecurityReason",value:function(){if(this._sock.rQwait("reason length",4))return!1;var e=this._sock.rQshift32(),t="";if(e>0){if(this._sock.rQwait("reason",e,4))return!1;t=this._sock.rQshiftStr(e)}return""!==t?(this.dispatchEvent(new CustomEvent("securityfailure",{detail:{status:this._securityStatus,reason:t}})),this._fail("Security negotiation failed on "+this._securityContext+" (reason: "+t+")")):(this.dispatchEvent(new CustomEvent("securityfailure",{detail:{status:this._securityStatus}})),this._fail("Security negotiation failed on "+this._securityContext))}},{key:"_negotiateXvpAuth",value:function(){return void 0===this._rfbCredentials.username||void 0===this._rfbCredentials.password||void 0===this._rfbCredentials.target?(this.dispatchEvent(new CustomEvent("credentialsrequired",{detail:{types:["username","password","target"]}})),!1):(this._sock.sQpush8(this._rfbCredentials.username.length),this._sock.sQpush8(this._rfbCredentials.target.length),this._sock.sQpushString(this._rfbCredentials.username),this._sock.sQpushString(this._rfbCredentials.target),this._sock.flush(),this._rfbAuthScheme=securityTypeVNCAuth,this._negotiateAuthentication())}},{key:"_negotiateVeNCryptAuth",value:function(){if(0==this._rfbVeNCryptState){if(this._sock.rQwait("vencrypt version",2))return!1;var e=this._sock.rQshift8(),t=this._sock.rQshift8();if(0!=e||2!=t)return this._fail("Unsupported VeNCrypt version "+e+"."+t);this._sock.sQpush8(0),this._sock.sQpush8(2),this._sock.flush(),this._rfbVeNCryptState=1}if(1==this._rfbVeNCryptState){if(this._sock.rQwait("vencrypt ack",1))return!1;var s=this._sock.rQshift8();if(0!=s)return this._fail("VeNCrypt failure "+s);this._rfbVeNCryptState=2}if(2==this._rfbVeNCryptState){if(this._sock.rQwait("vencrypt subtypes length",1))return!1;var i=this._sock.rQshift8();if(i<1)return this._fail("VeNCrypt subtypes empty");this._rfbVeNCryptSubtypesLength=i,this._rfbVeNCryptState=3}if(3==this._rfbVeNCryptState){if(this._sock.rQwait("vencrypt subtypes",4*this._rfbVeNCryptSubtypesLength))return!1;for(var n=[],r=0;r<this._rfbVeNCryptSubtypesLength;r++)n.push(this._sock.rQshift32());this._rfbAuthScheme=-1;for(var o=0,a=n;o<a.length;o++){var u=a[o];if(u!==securityTypeVeNCrypt&&this._isSupportedSecurityType(u)){this._rfbAuthScheme=u;break}}return-1===this._rfbAuthScheme?this._fail("Unsupported security types (types: "+n+")"):(this._sock.sQpush32(this._rfbAuthScheme),this._sock.flush(),this._rfbVeNCryptState=4,!0)}}},{key:"_negotiatePlainAuth",value:function(){if(void 0===this._rfbCredentials.username||void 0===this._rfbCredentials.password)return this.dispatchEvent(new CustomEvent("credentialsrequired",{detail:{types:["username","password"]}})),!1;var e=(0,_strings.encodeUTF8)(this._rfbCredentials.username),t=(0,_strings.encodeUTF8)(this._rfbCredentials.password);return this._sock.sQpush32(e.length),this._sock.sQpush32(t.length),this._sock.sQpushString(e),this._sock.sQpushString(t),this._sock.flush(),this._rfbInitState="SecurityResult",!0}},{key:"_negotiateStdVNCAuth",value:function(){if(this._sock.rQwait("auth challenge",16))return!1;if(void 0===this._rfbCredentials.password)return this.dispatchEvent(new CustomEvent("credentialsrequired",{detail:{types:["password"]}})),!1;var t=Array.prototype.slice.call(this._sock.rQshiftBytes(16)),s=e.genDES(this._rfbCredentials.password,t);return this._sock.sQpushBytes(s),this._sock.flush(),this._rfbInitState="SecurityResult",!0}},{key:"_negotiateARDAuth",value:function(){if(void 0===this._rfbCredentials.username||void 0===this._rfbCredentials.password)return this.dispatchEvent(new CustomEvent("credentialsrequired",{detail:{types:["username","password"]}})),!1;if(null!=this._rfbCredentials.ardPublicKey&&null!=this._rfbCredentials.ardCredentials)return this._sock.sQpushBytes(this._rfbCredentials.ardCredentials),this._sock.sQpushBytes(this._rfbCredentials.ardPublicKey),this._sock.flush(),this._rfbCredentials.ardCredentials=null,this._rfbCredentials.ardPublicKey=null,this._rfbInitState="SecurityResult",!0;if(this._sock.rQwait("read ard",4))return!1;var e=this._sock.rQshiftBytes(2),t=this._sock.rQshift16();if(this._sock.rQwait("read ard keylength",2*t,4))return!1;var s=this._sock.rQshiftBytes(t),i=this._sock.rQshiftBytes(t),n=_crypto.default.generateKey({name:"DH",g:e,p:s},!1,["deriveBits"]);return this._negotiateARDAuthAsync(t,i,n),!1}},{key:"_negotiateARDAuthAsync",value:(t=_asyncToGenerator(_regeneratorRuntime().mark((function e(t,s,i){var n,r,o,a,u,h,c,l,d,_;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(n=_crypto.default.exportKey("raw",i.publicKey),r=_crypto.default.deriveBits({name:"DH",public:s},i.privateKey,8*t),o=(0,_strings.encodeUTF8)(this._rfbCredentials.username).substring(0,63),a=(0,_strings.encodeUTF8)(this._rfbCredentials.password).substring(0,63),u=window.crypto.getRandomValues(new Uint8Array(128)),h=0;h<o.length;h++)u[h]=o.charCodeAt(h);for(u[o.length]=0,c=0;c<a.length;c++)u[64+c]=a.charCodeAt(c);return u[64+a.length]=0,e.next=11,_crypto.default.digest("MD5",r);case 11:return l=e.sent,e.next=14,_crypto.default.importKey("raw",l,{name:"AES-ECB"},!1,["encrypt"]);case 14:return d=e.sent,e.next=17,_crypto.default.encrypt({name:"AES-ECB"},d,u);case 17:_=e.sent,this._rfbCredentials.ardCredentials=_,this._rfbCredentials.ardPublicKey=n,this._resumeAuthentication();case 21:case"end":return e.stop()}}),e,this)}))),function(e,s,i){return t.apply(this,arguments)})},{key:"_negotiateTightUnixAuth",value:function(){return void 0===this._rfbCredentials.username||void 0===this._rfbCredentials.password?(this.dispatchEvent(new CustomEvent("credentialsrequired",{detail:{types:["username","password"]}})),!1):(this._sock.sQpush32(this._rfbCredentials.username.length),this._sock.sQpush32(this._rfbCredentials.password.length),this._sock.sQpushString(this._rfbCredentials.username),this._sock.sQpushString(this._rfbCredentials.password),this._sock.flush(),this._rfbInitState="SecurityResult",!0)}},{key:"_negotiateTightTunnels",value:function(e){for(var t={vendor:"TGHT",signature:"NOTUNNEL"},s={},i=0;i<e;i++){var n=this._sock.rQshift32(),r=this._sock.rQshiftStr(4),o=this._sock.rQshiftStr(8);s[n]={vendor:r,signature:o}}return Log.Debug("Server Tight tunnel types: "+s),s[1]&&"SICR"===s[1].vendor&&"SCHANNEL"===s[1].signature&&(Log.Debug("Detected Siemens server. Assuming NOTUNNEL support."),s[0]={vendor:"TGHT",signature:"NOTUNNEL"}),s[0]?s[0].vendor!=t.vendor||s[0].signature!=t.signature?this._fail("Client's tunnel type had the incorrect vendor or signature"):(Log.Debug("Selected tunnel type: "+t),this._sock.sQpush32(0),this._sock.flush(),!1):this._fail("Server wanted tunnels, but doesn't support the notunnel type")}},{key:"_negotiateTightAuth",value:function(){if(!this._rfbTightVNC){if(this._sock.rQwait("num tunnels",4))return!1;var e=this._sock.rQshift32();if(e>0&&this._sock.rQwait("tunnel capabilities",16*e,4))return!1;if(this._rfbTightVNC=!0,e>0)return this._negotiateTightTunnels(e),!1}if(this._sock.rQwait("sub auth count",4))return!1;var t=this._sock.rQshift32();if(0===t)return this._rfbInitState="SecurityResult",!0;if(this._sock.rQwait("sub auth capabilities",16*t,4))return!1;for(var s={STDVNOAUTH__:1,STDVVNCAUTH_:2,TGHTULGNAUTH:129},i=[],n=0;n<t;n++){this._sock.rQshift32();var r=this._sock.rQshiftStr(12);i.push(r)}for(var o in Log.Debug("Server Tight authentication types: "+i),s)if(-1!=i.indexOf(o))switch(this._sock.sQpush32(s[o]),this._sock.flush(),Log.Debug("Selected authentication type: "+o),o){case"STDVNOAUTH__":return this._rfbInitState="SecurityResult",!0;case"STDVVNCAUTH_":return this._rfbAuthScheme=securityTypeVNCAuth,!0;case"TGHTULGNAUTH":return this._rfbAuthScheme=securityTypeUnixLogon,!0;default:return this._fail("Unsupported tiny auth scheme (scheme: "+o+")")}return this._fail("No supported sub-auth types!")}},{key:"_handleRSAAESCredentialsRequired",value:function(e){this.dispatchEvent(e)}},{key:"_handleRSAAESServerVerification",value:function(e){this.dispatchEvent(e)}},{key:"_negotiateRA2neAuth",value:function(){var e=this;return null===this._rfbRSAAESAuthenticationState&&(this._rfbRSAAESAuthenticationState=new _ra.default(this._sock,(function(){return e._rfbCredentials})),this._rfbRSAAESAuthenticationState.addEventListener("serververification",this._eventHandlers.handleRSAAESServerVerification),this._rfbRSAAESAuthenticationState.addEventListener("credentialsrequired",this._eventHandlers.handleRSAAESCredentialsRequired)),this._rfbRSAAESAuthenticationState.checkInternalEvents(),this._rfbRSAAESAuthenticationState.hasStarted||this._rfbRSAAESAuthenticationState.negotiateRA2neAuthAsync().catch((function(t){"disconnect normally"!==t.message&&e._fail(t.message)})).then((function(){return e._rfbInitState="SecurityResult",!0})).finally((function(){e._rfbRSAAESAuthenticationState.removeEventListener("serververification",e._eventHandlers.handleRSAAESServerVerification),e._rfbRSAAESAuthenticationState.removeEventListener("credentialsrequired",e._eventHandlers.handleRSAAESCredentialsRequired),e._rfbRSAAESAuthenticationState=null})),!1}},{key:"_negotiateMSLogonIIAuth",value:function(){if(this._sock.rQwait("mslogonii dh param",24))return!1;if(void 0===this._rfbCredentials.username||void 0===this._rfbCredentials.password)return this.dispatchEvent(new CustomEvent("credentialsrequired",{detail:{types:["username","password"]}})),!1;var e=this._sock.rQshiftBytes(8),t=this._sock.rQshiftBytes(8),s=this._sock.rQshiftBytes(8),i=_crypto.default.generateKey({name:"DH",g:e,p:t},!0,["deriveBits"]),n=_crypto.default.exportKey("raw",i.publicKey),r=_crypto.default.deriveBits({name:"DH",public:s},i.privateKey,64),o=_crypto.default.importKey("raw",r,{name:"DES-CBC"},!1,["encrypt"]),a=(0,_strings.encodeUTF8)(this._rfbCredentials.username).substring(0,255),u=(0,_strings.encodeUTF8)(this._rfbCredentials.password).substring(0,63),h=new Uint8Array(256),c=new Uint8Array(64);window.crypto.getRandomValues(h),window.crypto.getRandomValues(c);for(var l=0;l<a.length;l++)h[l]=a.charCodeAt(l);h[a.length]=0;for(var d=0;d<u.length;d++)c[d]=u.charCodeAt(d);return c[u.length]=0,h=_crypto.default.encrypt({name:"DES-CBC",iv:r},o,h),c=_crypto.default.encrypt({name:"DES-CBC",iv:r},o,c),this._sock.sQpushBytes(n),this._sock.sQpushBytes(h),this._sock.sQpushBytes(c),this._sock.flush(),this._rfbInitState="SecurityResult",!0}},{key:"_negotiateAuthentication",value:function(){switch(this._rfbAuthScheme){case securityTypeNone:return this._rfbVersion>=3.8?this._rfbInitState="SecurityResult":this._rfbInitState="ClientInitialisation",!0;case securityTypeXVP:return this._negotiateXvpAuth();case securityTypeARD:return this._negotiateARDAuth();case securityTypeVNCAuth:return this._negotiateStdVNCAuth();case securityTypeTight:return this._negotiateTightAuth();case securityTypeVeNCrypt:return this._negotiateVeNCryptAuth();case securityTypePlain:return this._negotiatePlainAuth();case securityTypeUnixLogon:return this._negotiateTightUnixAuth();case securityTypeRA2ne:return this._negotiateRA2neAuth();case securityTypeMSLogonII:return this._negotiateMSLogonIIAuth();default:return this._fail("Unsupported auth scheme (scheme: "+this._rfbAuthScheme+")")}}},{key:"_handleSecurityResult",value:function(){if(this._sock.rQwait("VNC auth response ",4))return!1;var e=this._sock.rQshift32();return 0===e?(this._rfbInitState="ClientInitialisation",Log.Debug("Authentication OK"),!0):this._rfbVersion>=3.8?(this._rfbInitState="SecurityReason",this._securityContext="security result",this._securityStatus=e,!0):(this.dispatchEvent(new CustomEvent("securityfailure",{detail:{status:e}})),this._fail("Security handshake failed"))}},{key:"_negotiateServerInit",value:function(){if(this._sock.rQwait("server initialization",24))return!1;var t=this._sock.rQshift16(),s=this._sock.rQshift16(),i=this._sock.rQshift8(),n=this._sock.rQshift8(),r=this._sock.rQshift8(),o=this._sock.rQshift8(),a=this._sock.rQshift16(),u=this._sock.rQshift16(),h=this._sock.rQshift16(),c=this._sock.rQshift8(),l=this._sock.rQshift8(),d=this._sock.rQshift8();this._sock.rQskipBytes(3);var _=this._sock.rQshift32();if(this._sock.rQwait("server init name",_,24))return!1;var p=this._sock.rQshiftStr(_);if(p=(0,_strings.decodeUTF8)(p,!0),this._rfbTightVNC){if(this._sock.rQwait("TightVNC extended server init header",8,24+_))return!1;var f=this._sock.rQshift16(),g=this._sock.rQshift16(),y=this._sock.rQshift16();this._sock.rQskipBytes(2);var v=16*(f+g+y);if(this._sock.rQwait("TightVNC extended server init header",v,32+_))return!1;this._sock.rQskipBytes(16*f),this._sock.rQskipBytes(16*g),this._sock.rQskipBytes(16*y)}return Log.Info("Screen: "+t+"x"+s+", bpp: "+i+", depth: "+n+", bigEndian: "+r+", trueColor: "+o+", redMax: "+a+", greenMax: "+u+", blueMax: "+h+", redShift: "+c+", greenShift: "+l+", blueShift: "+d),this._setDesktopName(p),this._resize(t,s),this._viewOnly||this._keyboard.grab(),this._fbDepth=24,"Intel(r) AMT KVM"===this._fbName&&(Log.Warn("Intel AMT KVM only supports 8/16 bit depths. Using low color mode."),this._fbDepth=8),e.messages.pixelFormat(this._sock,this._fbDepth,!0),this._sendEncodings(),e.messages.fbUpdateRequest(this._sock,!1,0,0,this._fbWidth,this._fbHeight),this._updateConnectionState("connected"),!0}},{key:"_sendEncodings",value:function(){var t=[];t.push(_encodings.encodings.encodingCopyRect),24==this._fbDepth&&(_browser.supportsWebCodecsH264Decode&&t.push(_encodings.encodings.encodingH264),t.push(_encodings.encodings.encodingTight),t.push(_encodings.encodings.encodingTightPNG),t.push(_encodings.encodings.encodingZRLE),t.push(_encodings.encodings.encodingJPEG),t.push(_encodings.encodings.encodingHextile),t.push(_encodings.encodings.encodingRRE),t.push(_encodings.encodings.encodingZlib)),t.push(_encodings.encodings.encodingRaw),t.push(_encodings.encodings.pseudoEncodingQualityLevel0+this._qualityLevel),t.push(_encodings.encodings.pseudoEncodingCompressLevel0+this._compressionLevel),t.push(_encodings.encodings.pseudoEncodingDesktopSize),t.push(_encodings.encodings.pseudoEncodingLastRect),t.push(_encodings.encodings.pseudoEncodingQEMUExtendedKeyEvent),t.push(_encodings.encodings.pseudoEncodingQEMULedEvent),t.push(_encodings.encodings.pseudoEncodingExtendedDesktopSize),t.push(_encodings.encodings.pseudoEncodingXvp),t.push(_encodings.encodings.pseudoEncodingFence),t.push(_encodings.encodings.pseudoEncodingContinuousUpdates),t.push(_encodings.encodings.pseudoEncodingDesktopName),t.push(_encodings.encodings.pseudoEncodingExtendedClipboard),t.push(_encodings.encodings.pseudoEncodingExtendedMouseButtons),24==this._fbDepth&&(t.push(_encodings.encodings.pseudoEncodingVMwareCursor),t.push(_encodings.encodings.pseudoEncodingCursor)),e.messages.clientEncodings(this._sock,t)}},{key:"_initMsg",value:function(){switch(this._rfbInitState){case"ProtocolVersion":return this._negotiateProtocolVersion();case"Security":return this._negotiateSecurity();case"Authentication":return this._negotiateAuthentication();case"SecurityResult":return this._handleSecurityResult();case"SecurityReason":return this._handleSecurityReason();case"ClientInitialisation":return this._sock.sQpush8(this._shared?1:0),this._sock.flush(),this._rfbInitState="ServerInitialisation",!0;case"ServerInitialisation":return this._negotiateServerInit();default:return this._fail("Unknown init state (state: "+this._rfbInitState+")")}}},{key:"_resumeAuthentication",value:function(){setTimeout(this._initMsg.bind(this),0)}},{key:"_handleSetColourMapMsg",value:function(){return Log.Debug("SetColorMapEntries"),this._fail("Unexpected SetColorMapEntries message")}},{key:"_handleServerCutText",value:function(){if(Log.Debug("ServerCutText"),this._sock.rQwait("ServerCutText header",7,1))return!1;this._sock.rQskipBytes(3);var t=this._sock.rQshift32();if(t=(0,_int.toSigned32bit)(t),this._sock.rQwait("ServerCutText content",Math.abs(t),8))return!1;if(t>=0){var s=this._sock.rQshiftStr(t);if(this._viewOnly)return!0;this.dispatchEvent(new CustomEvent("clipboard",{detail:{text:s}}))}else{t=Math.abs(t);var i=this._sock.rQshift32(),n=65535&i,r=4278190080&i;if(!!(r&extendedClipboardActionCaps)){this._clipboardServerCapabilitiesFormats={},this._clipboardServerCapabilitiesActions={};for(var o=0;o<=15;o++){var a=1<<o;n&a&&(this._clipboardServerCapabilitiesFormats[a]=!0,this._sock.rQshift32())}for(var u=24;u<=31;u++){var h=1<<u;this._clipboardServerCapabilitiesActions[h]=!!(r&h)}var c=[extendedClipboardActionCaps,extendedClipboardActionRequest,extendedClipboardActionPeek,extendedClipboardActionNotify,extendedClipboardActionProvide];e.messages.extendedClipboardCaps(this._sock,c,{extendedClipboardFormatText:0})}else if(r===extendedClipboardActionRequest){if(this._viewOnly)return!0;null!=this._clipboardText&&this._clipboardServerCapabilitiesActions[extendedClipboardActionProvide]&&n&extendedClipboardFormatText&&e.messages.extendedClipboardProvide(this._sock,[extendedClipboardFormatText],[this._clipboardText])}else if(r===extendedClipboardActionPeek){if(this._viewOnly)return!0;this._clipboardServerCapabilitiesActions[extendedClipboardActionNotify]&&(null!=this._clipboardText?e.messages.extendedClipboardNotify(this._sock,[extendedClipboardFormatText]):e.messages.extendedClipboardNotify(this._sock,[]))}else if(r===extendedClipboardActionNotify){if(this._viewOnly)return!0;this._clipboardServerCapabilitiesActions[extendedClipboardActionRequest]&&n&extendedClipboardFormatText&&e.messages.extendedClipboardRequest(this._sock,[extendedClipboardFormatText])}else{if(r!==extendedClipboardActionProvide)return this._fail("Unexpected action in extended clipboard message: "+r);if(this._viewOnly)return!0;if(!(n&extendedClipboardFormatText))return!0;this._clipboardText=null;var l=this._sock.rQshiftBytes(t-4),d=new _inflator.default,_=null;d.setInput(l);for(var p=0;p<=15;p++){var f=1<<p;if(n&f){var g=0,y=d.inflate(4);g|=y[0]<<24,g|=y[1]<<16,g|=y[2]<<8,g|=y[3];var v=d.inflate(g);f===extendedClipboardFormatText&&(_=v)}}if(d.setInput(null),null!==_){for(var b="",k=0;k<_.length;k++)b+=String.fromCharCode(_[k]);_=b,(_=(0,_strings.decodeUTF8)(_)).length>0&&"\0"===_.charAt(_.length-1)&&(_=_.slice(0,-1)),_=_.replaceAll("\r\n","\n"),this.dispatchEvent(new CustomEvent("clipboard",{detail:{text:_}}))}}}return!0}},{key:"_handleServerFenceMsg",value:function(){if(this._sock.rQwait("ServerFence header",8,1))return!1;this._sock.rQskipBytes(3);var t=this._sock.rQshift32(),s=this._sock.rQshift8();if(this._sock.rQwait("ServerFence payload",s,9))return!1;s>64&&(Log.Warn("Bad payload length ("+s+") in fence response"),s=64);var i=this._sock.rQshiftStr(s);return this._supportsFence=!0,t&1<<31?(t&=3,e.messages.clientFence(this._sock,t,i),!0):this._fail("Unexpected fence response")}},{key:"_handleXvpMsg",value:function(){if(this._sock.rQwait("XVP version and message",3,1))return!1;this._sock.rQskipBytes(1);var e=this._sock.rQshift8(),t=this._sock.rQshift8();switch(t){case 0:Log.Error("XVP operation failed");break;case 1:this._rfbXvpVer=e,Log.Info("XVP extensions enabled (version "+this._rfbXvpVer+")"),this._setCapability("power",!0);break;default:this._fail("Illegal server XVP message (msg: "+t+")")}return!0}},{key:"_normalMsg",value:function(){var t,s,i;switch(t=this._FBU.rects>0?0:this._sock.rQshift8()){case 0:return(i=this._framebufferUpdate())&&!this._enabledContinuousUpdates&&e.messages.fbUpdateRequest(this._sock,!0,0,0,this._fbWidth,this._fbHeight),i;case 1:return this._handleSetColourMapMsg();case 2:return Log.Debug("Bell"),this.dispatchEvent(new CustomEvent("bell",{detail:{}})),!0;case 3:return this._handleServerCutText();case 150:return s=!this._supportsContinuousUpdates,this._supportsContinuousUpdates=!0,this._enabledContinuousUpdates=!1,s&&(this._enabledContinuousUpdates=!0,this._updateContinuousUpdates(),Log.Info("Enabling continuous updates.")),!0;case 248:return this._handleServerFenceMsg();case 250:return this._handleXvpMsg();default:return this._fail("Unexpected server message (type "+t+")"),Log.Debug("sock.rQpeekBytes(30): "+this._sock.rQpeekBytes(30)),!0}}},{key:"_framebufferUpdate",value:function(){var e=this;if(0===this._FBU.rects){if(this._sock.rQwait("FBU header",3,1))return!1;if(this._sock.rQskipBytes(1),this._FBU.rects=this._sock.rQshift16(),this._display.pending())return this._flushing=!0,this._display.flush().then((function(){e._flushing=!1,e._sock.rQwait("message",1)||e._handleMessage()})),!1}for(;this._FBU.rects>0;){if(null===this._FBU.encoding){if(this._sock.rQwait("rect header",12))return!1;this._FBU.x=this._sock.rQshift16(),this._FBU.y=this._sock.rQshift16(),this._FBU.width=this._sock.rQshift16(),this._FBU.height=this._sock.rQshift16(),this._FBU.encoding=this._sock.rQshift32(),this._FBU.encoding>>=0}if(!this._handleRect())return!1;this._FBU.rects--,this._FBU.encoding=null}return this._display.flip(),!0}},{key:"_handleRect",value:function(){switch(this._FBU.encoding){case _encodings.encodings.pseudoEncodingLastRect:return this._FBU.rects=1,!0;case _encodings.encodings.pseudoEncodingVMwareCursor:return this._handleVMwareCursor();case _encodings.encodings.pseudoEncodingCursor:return this._handleCursor();case _encodings.encodings.pseudoEncodingQEMUExtendedKeyEvent:return this._qemuExtKeyEventSupported=!0,!0;case _encodings.encodings.pseudoEncodingDesktopName:return this._handleDesktopName();case _encodings.encodings.pseudoEncodingDesktopSize:return this._resize(this._FBU.width,this._FBU.height),!0;case _encodings.encodings.pseudoEncodingExtendedDesktopSize:return this._handleExtendedDesktopSize();case _encodings.encodings.pseudoEncodingExtendedMouseButtons:return this._extendedPointerEventSupported=!0,!0;case _encodings.encodings.pseudoEncodingQEMULedEvent:return this._handleLedEvent();default:return this._handleDataRect()}}},{key:"_handleVMwareCursor",value:function(){var e=this._FBU.x,t=this._FBU.y,s=this._FBU.width,i=this._FBU.height;if(this._sock.rQwait("VMware cursor encoding",1))return!1;var n,r=this._sock.rQshift8();this._sock.rQshift8();if(0==r){var o=-256;if(n=new Array(s*i*4),this._sock.rQwait("VMware cursor classic encoding",s*i*4*2,2))return!1;for(var a=new Array(s*i),u=0;u<s*i;u++)a[u]=this._sock.rQshift32();for(var h=new Array(s*i),c=0;c<s*i;c++)h[c]=this._sock.rQshift32();for(var l=0;l<s*i;l++)if(0==a[l]){var d=h[l],_=d>>8&255,p=d>>16&255,f=d>>24&255;n[4*l]=_,n[4*l+1]=p,n[4*l+2]=f,n[4*l+3]=255}else(a[l]&o)==o?0==h[l]?(n[4*l]=0,n[4*l+1]=0,n[4*l+2]=0,n[4*l+3]=0):(h[l],n[4*l]=0,n[4*l+1]=0,n[4*l+2]=0,n[4*l+3]=255):(n[4*l]=0,n[4*l+1]=0,n[4*l+2]=0,n[4*l+3]=255)}else{if(1!=r)return Log.Warn("The given cursor type is not supported: "+r+" given."),!1;if(this._sock.rQwait("VMware cursor alpha encoding",s*i*4,2))return!1;n=new Array(s*i*4);for(var g=0;g<s*i;g++){var y=this._sock.rQshift32();n[4*g]=y>>24&255,n[4*g+1]=y>>16&255,n[4*g+2]=y>>8&255,n[4*g+3]=255&y}}return this._updateCursor(n,e,t,s,i),!0}},{key:"_handleCursor",value:function(){var e=this._FBU.x,t=this._FBU.y,s=this._FBU.width,i=this._FBU.height,n=s*i*4,r=Math.ceil(s/8)*i,o=n+r;if(this._sock.rQwait("cursor encoding",o))return!1;for(var a=this._sock.rQshiftBytes(n),u=this._sock.rQshiftBytes(r),h=new Uint8Array(s*i*4),c=0,l=0;l<i;l++)for(var d=0;d<s;d++){var _=u[l*Math.ceil(s/8)+Math.floor(d/8)]<<d%8&128?255:0;h[c]=a[c+2],h[c+1]=a[c+1],h[c+2]=a[c],h[c+3]=_,c+=4}return this._updateCursor(h,e,t,s,i),!0}},{key:"_handleDesktopName",value:function(){if(this._sock.rQwait("DesktopName",4))return!1;var e=this._sock.rQshift32();if(this._sock.rQwait("DesktopName",e,4))return!1;var t=this._sock.rQshiftStr(e);return t=(0,_strings.decodeUTF8)(t,!0),this._setDesktopName(t),!0}},{key:"_handleLedEvent",value:function(){if(this._sock.rQwait("LED status",1))return!1;var e=this._sock.rQshift8(),t=!!(2&e),s=!!(4&e);return this._remoteCapsLock=s,this._remoteNumLock=t,!0}},{key:"_handleExtendedDesktopSize",value:function(){if(this._sock.rQwait("ExtendedDesktopSize",4))return!1;var e=this._sock.rQpeek8(),t=4+16*e;if(this._sock.rQwait("ExtendedDesktopSize",t))return!1;var s=!this._supportsSetDesktopSize;this._supportsSetDesktopSize=!0,this._sock.rQskipBytes(1),this._sock.rQskipBytes(3);for(var i=0;i<e;i+=1)0===i?(this._screenID=this._sock.rQshift32(),this._sock.rQskipBytes(2),this._sock.rQskipBytes(2),this._sock.rQskipBytes(2),this._sock.rQskipBytes(2),this._screenFlags=this._sock.rQshift32()):this._sock.rQskipBytes(16);if(1===this._FBU.x&&(this._pendingRemoteResize=!1),1===this._FBU.x&&0!==this._FBU.y){var n="";switch(this._FBU.y){case 1:n="Resize is administratively prohibited";break;case 2:n="Out of resources";break;case 3:n="Invalid screen layout";break;default:n="Unknown reason"}Log.Warn("Server did not accept the resize request: "+n)}else this._resize(this._FBU.width,this._FBU.height);return s&&this._requestRemoteResize(),1===this._FBU.x&&0===this._FBU.y&&this._requestRemoteResize(),!0}},{key:"_handleDataRect",value:function(){var e=this._decoders[this._FBU.encoding];if(!e)return this._fail("Unsupported encoding (encoding: "+this._FBU.encoding+")"),!1;try{return e.decodeRect(this._FBU.x,this._FBU.y,this._FBU.width,this._FBU.height,this._sock,this._display,this._fbDepth)}catch(e){return this._fail("Error decoding rect: "+e),!1}}},{key:"_updateContinuousUpdates",value:function(){this._enabledContinuousUpdates&&e.messages.enableContinuousUpdates(this._sock,!0,0,0,this._fbWidth,this._fbHeight)}},{key:"_resize",value:function(e,t){this._fbWidth=e,this._fbHeight=t,this._display.resize(this._fbWidth,this._fbHeight),this._updateClip(),this._updateScale(),this._updateContinuousUpdates(),this._saveExpectedClientSize()}},{key:"_xvpOp",value:function(t,s){this._rfbXvpVer<t||(Log.Info("Sending XVP operation "+s+" (version "+t+")"),e.messages.xvpOp(this._sock,t,s))}},{key:"_updateCursor",value:function(e,t,s,i,n){this._cursorImage={rgbaPixels:e,hotx:t,hoty:s,w:i,h:n},this._refreshCursor()}},{key:"_shouldShowDotCursor",value:function(){if(!this._showDotCursor)return!1;for(var e=3;e<this._cursorImage.rgbaPixels.length;e+=4)if(this._cursorImage.rgbaPixels[e])return!1;return!0}},{key:"_refreshCursor",value:function(){if("connecting"===this._rfbConnectionState||"connected"===this._rfbConnectionState){var t=this._shouldShowDotCursor()?e.cursors.dot:this._cursorImage;this._cursor.change(t.rgbaPixels,t.hotx,t.hoty,t.w,t.h)}}}],[{key:"_convertButtonMask",value:function(e){for(var t={0:1,1:4,2:2,3:128,4:256},s=0,i=0;i<5;i++)e&1<<i&&(s|=t[i]);return s}},{key:"genDES",value:function(e,t){var s=e.split("").map((function(e){return e.charCodeAt(0)})),i=_crypto.default.importKey("raw",s,{name:"DES-ECB"},!1,["encrypt"]);return _crypto.default.encrypt({name:"DES-ECB"},i,t)}}]);var t}();RFB.messages={keyEvent:function(e,t,s){e.sQpush8(4),e.sQpush8(s),e.sQpush16(0),e.sQpush32(t),e.flush()},QEMUExtendedKeyEvent:function(e,t,s,i){e.sQpush8(255),e.sQpush8(0),e.sQpush16(s),e.sQpush32(t);var n,r,o=(n=i,r=255&i,224==i>>8&&r<127?128|r:n);e.sQpush32(o),e.flush()},pointerEvent:function(e,t,s,i){e.sQpush8(5),i&=127,e.sQpush8(i),e.sQpush16(t),e.sQpush16(s),e.flush()},extendedPointerEvent:function(e,t,s,i){e.sQpush8(5);var n=i>>7&255;if(252&n)throw new Error("Invalid mouse button mask: "+i);var r=127&i;r|=128,e.sQpush8(r),e.sQpush16(t),e.sQpush16(s),e.sQpush8(n),e.flush()},_buildExtendedClipboardFlags:function(e,t){for(var s=new Uint8Array(4),i=0,n=0,r=0;r<e.length;r++)n|=e[r];for(var o=0;o<t.length;o++)i|=t[o];return s[0]=n>>24,s[1]=0,s[2]=0,s[3]=i,s},extendedClipboardProvide:function(e,t,s){for(var i=new _deflator.default,n=[],r=0;r<t.length;r++){if(t[r]!=extendedClipboardFormatText)throw new Error("Unsupported extended clipboard format for Provide message.");s[r]=s[r].replace(/\r\n|\r|\n/gm,"\r\n");var o=(0,_strings.encodeUTF8)(s[r]+"\0");n.push(o.length>>24&255,o.length>>16&255,o.length>>8&255,255&o.length);for(var a=0;a<o.length;a++)n.push(o.charCodeAt(a))}var u=i.deflate(new Uint8Array(n)),h=new Uint8Array(4+u.length);h.set(RFB.messages._buildExtendedClipboardFlags([extendedClipboardActionProvide],t)),h.set(u,4),RFB.messages.clientCutText(e,h,!0)},extendedClipboardNotify:function(e,t){var s=RFB.messages._buildExtendedClipboardFlags([extendedClipboardActionNotify],t);RFB.messages.clientCutText(e,s,!0)},extendedClipboardRequest:function(e,t){var s=RFB.messages._buildExtendedClipboardFlags([extendedClipboardActionRequest],t);RFB.messages.clientCutText(e,s,!0)},extendedClipboardCaps:function(e,t,s){var i=Object.keys(s),n=new Uint8Array(4+4*i.length);i.map((function(e){return parseInt(e)})),i.sort((function(e,t){return e-t})),n.set(RFB.messages._buildExtendedClipboardFlags(t,[]));for(var r=4,o=0;o<i.length;o++)n[r]=s[i[o]]>>24,n[r+1]=s[i[o]]>>16,n[r+2]=s[i[o]]>>8,n[r+3]=s[i[o]]|0,r+=4,n[3]|=1<<i[o];RFB.messages.clientCutText(e,n,!0)},clientCutText:function(e,t){var s,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];e.sQpush8(6),e.sQpush8(0),e.sQpush8(0),e.sQpush8(0),s=i?(0,_int.toUnsigned32bit)(-t.length):t.length,e.sQpush32(s),e.sQpushBytes(t),e.flush()},setDesktopSize:function(e,t,s,i,n){e.sQpush8(251),e.sQpush8(0),e.sQpush16(t),e.sQpush16(s),e.sQpush8(1),e.sQpush8(0),e.sQpush32(i),e.sQpush16(0),e.sQpush16(0),e.sQpush16(t),e.sQpush16(s),e.sQpush32(n),e.flush()},clientFence:function(e,t,s){e.sQpush8(248),e.sQpush8(0),e.sQpush8(0),e.sQpush8(0),e.sQpush32(t),e.sQpush8(s.length),e.sQpushString(s),e.flush()},enableContinuousUpdates:function(e,t,s,i,n,r){e.sQpush8(150),e.sQpush8(t),e.sQpush16(s),e.sQpush16(i),e.sQpush16(n),e.sQpush16(r),e.flush()},pixelFormat:function(e,t,s){var i;i=t>16?32:t>8?16:8;var n=Math.floor(t/3);e.sQpush8(0),e.sQpush8(0),e.sQpush8(0),e.sQpush8(0),e.sQpush8(i),e.sQpush8(t),e.sQpush8(0),e.sQpush8(s?1:0),e.sQpush16((1<<n)-1),e.sQpush16((1<<n)-1),e.sQpush16((1<<n)-1),e.sQpush8(0*n),e.sQpush8(1*n),e.sQpush8(2*n),e.sQpush8(0),e.sQpush8(0),e.sQpush8(0),e.flush()},clientEncodings:function(e,t){e.sQpush8(2),e.sQpush8(0),e.sQpush16(t.length);for(var s=0;s<t.length;s++)e.sQpush32(t[s]);e.flush()},fbUpdateRequest:function(e,t,s,i,n,r){void 0===s&&(s=0),void 0===i&&(i=0),e.sQpush8(3),e.sQpush8(t?1:0),e.sQpush16(s),e.sQpush16(i),e.sQpush16(n),e.sQpush16(r),e.flush()},xvpOp:function(e,t,s){e.sQpush8(250),e.sQpush8(0),e.sQpush8(t),e.sQpush8(s),e.flush()}},RFB.cursors={none:{rgbaPixels:new Uint8Array,w:0,h:0,hotx:0,hoty:0},dot:{rgbaPixels:new Uint8Array([255,255,255,255,0,0,0,255,255,255,255,255,0,0,0,255,0,0,0,0,0,0,0,255,255,255,255,255,0,0,0,255,255,255,255,255]),w:3,h:3,hotx:1,hoty:1}};
//# sourceMappingURL=/sm/30066c323b38b141e3b6eec3d0f2a21addd3182c5ef13d9c2fbda9d801f8b1f9.map