/**
 * Minified by jsDelivr using Terser v5.39.0.
 * Original file: /npm/@flexem/novnc@1.1.6/core/rfb.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{toUnsigned32bit,toSigned32bit}from"./util/int.js";import*as Log from"./util/logging.js";import{encodeUTF8,decodeUTF8}from"./util/strings.js";import{dragThreshold}from"./util/browser.js";import EventTargetMixin from"./util/eventtarget.js";import Display from"./display.js";import Inflator from"./inflator.js";import Deflator from"./deflator.js";import Keyboard from"./input/keyboard.js";import Mouse from"./input/mouse.js";import Cursor from"./util/cursor.js";import Websock from"./websock.js";import DES from"./des.js";import KeyTable from"./input/keysym.js";import XtScancode from"./input/xtscancodes.js";import{encodings}from"./encodings.js";import"./util/polyfill.js";import RawDecoder from"./decoders/raw.js";import CopyRectDecoder from"./decoders/copyrect.js";import RREDecoder from"./decoders/rre.js";import HextileDecoder from"./decoders/hextile.js";import TightDecoder from"./decoders/tight.js";import TightPNGDecoder from"./decoders/tightpng.js";const DISCONNECT_TIMEOUT=3,DEFAULT_BACKGROUND="rgb(40, 40, 40)",extendedClipboardFormatText=1,extendedClipboardFormatRtf=2,extendedClipboardFormatHtml=4,extendedClipboardFormatDib=8,extendedClipboardFormatFiles=16,extendedClipboardActionCaps=1<<24,extendedClipboardActionRequest=1<<25,extendedClipboardActionPeek=1<<26,extendedClipboardActionNotify=1<<27,extendedClipboardActionProvide=1<<28;export default class RFB extends EventTargetMixin{constructor(e,t,s){if(!e)throw new Error("Must specify target");if(!t)throw new Error("Must specify URL");super(),this._target=e,this._url=t,s=s||{},this._rfb_credentials=s.credentials||{},this._shared=!("shared"in s)||!!s.shared,this._repeaterID=s.repeaterID||"",this._wsProtocols=s.wsProtocols||[],this._rfb_connection_state="",this._rfb_init_state="",this._rfb_auth_scheme=-1,this._rfb_clean_disconnect=!0,this._rfb_version=0,this._rfb_max_version=3.8,this._rfb_tightvnc=!1,this._rfb_xvp_ver=0,this._fb_width=0,this._fb_height=0,this._fb_name="",this._capabilities={power:!1},this._supportsFence=!1,this._supportsContinuousUpdates=!1,this._enabledContinuousUpdates=!1,this._supportsSetDesktopSize=!1,this._screen_id=0,this._screen_flags=0,this._qemuExtKeyEventSupported=!1,this._clipboardText=null,this._clipboardServerCapabilitiesActions={},this._clipboardServerCapabilitiesFormats={},this._sock=null,this._display=null,this._flushing=!1,this._keyboard=null,this._mouse=null,this._disconnTimer=null,this._resizeTimeout=null,this._decoders={},this._FBU={rects:0,x:0,y:0,width:0,height:0,encoding:null},this._mouse_buttonMask=0,this._mouse_buttonMaskLastMs=0,this._mouse_arr=[],this._viewportDragging=!1,this._viewportDragPos={},this._viewportHasMoved=!1,this._eventHandlers={focusCanvas:this._focusCanvas.bind(this),windowResize:this._windowResize.bind(this)},Log.Debug(">> RFB.constructor"),this._screen=document.createElement("div"),this._screen.style.display="flex",this._screen.style.width="100%",this._screen.style.height="100%",this._screen.style.overflow="auto",this._screen.style.background="rgb(40, 40, 40)",this._canvas=document.createElement("canvas"),this._canvas.style.margin="auto",this._canvas.style.outline="none",this._canvas.style.flexShrink="0",this._canvas.width=0,this._canvas.height=0,this._canvas.tabIndex=-1,this._screen.appendChild(this._canvas),this._cursor=new Cursor,this._cursorImage=RFB.cursors.none,this._decoders[encodings.encodingRaw]=new RawDecoder,this._decoders[encodings.encodingCopyRect]=new CopyRectDecoder,this._decoders[encodings.encodingRRE]=new RREDecoder,this._decoders[encodings.encodingHextile]=new HextileDecoder,this._decoders[encodings.encodingTight]=new TightDecoder,this._decoders[encodings.encodingTightPNG]=new TightPNGDecoder;try{this._display=new Display(this._canvas)}catch(e){throw Log.Error("Display exception: "+e),e}this._display.onflush=this._onFlush.bind(this),this._keyboard=new Keyboard(this._canvas),this._keyboard.onkeyevent=this._handleKeyEvent.bind(this),this._mouse=new Mouse(this._canvas),this._mouse.onmousebutton=this._handleMouseButton.bind(this),this._mouse.onmousemove=this._handleMouseMove.bind(this),this._sock=new Websock,this._sock.on("message",(()=>{this._handle_message()})),this._sock.on("open",(()=>{"connecting"===this._rfb_connection_state&&""===this._rfb_init_state?(this._rfb_init_state="ProtocolVersion",Log.Debug("Starting VNC handshake")):this._fail("Unexpected server connection while "+this._rfb_connection_state)})),this._sock.on("close",(e=>{Log.Debug("WebSocket on-close event");let t="";switch(e.code&&(t="(code: "+e.code,e.reason&&(t+=", reason: "+e.reason),t+=")"),this._rfb_connection_state){case"connecting":this._fail("Connection closed "+t);break;case"connected":this._updateConnectionState("disconnecting"),this._updateConnectionState("disconnected");break;case"disconnecting":this._updateConnectionState("disconnected");break;case"disconnected":this._fail("Unexpected server disconnect when already disconnected "+t);break;default:this._fail("Unexpected server disconnect before connecting "+t)}this._sock.off("close")})),this._sock.on("error",(e=>Log.Warn("WebSocket on-error event"))),setTimeout(this._updateConnectionState.bind(this,"connecting")),Log.Debug("<< RFB.constructor"),this.dragViewport=!1,this.dragDelayMs=300,this.focusOnClick=!0,this._viewOnly=!1,this._clipViewport=!1,this._scaleViewport=!1,this._resizeSession=!1,this._showDotCursor=!1,void 0!==s.showDotCursor&&(Log.Warn("Specifying showDotCursor as a RFB constructor argument is deprecated"),this._showDotCursor=s.showDotCursor),this._qualityLevel=6}get viewOnly(){return this._viewOnly}set viewOnly(e){this._viewOnly=e,"connecting"!==this._rfb_connection_state&&"connected"!==this._rfb_connection_state||(e?(this._keyboard.ungrab(),this._mouse.ungrab()):(this._keyboard.grab(),this._mouse.grab()))}get capabilities(){return this._capabilities}get touchButton(){return this._mouse.touchButton}set touchButton(e){this._mouse.touchButton=e}get clipViewport(){return this._clipViewport}set clipViewport(e){this._clipViewport=e,this._updateClip()}get scaleViewport(){return this._scaleViewport}set scaleViewport(e){this._scaleViewport=e,e&&this._clipViewport&&this._updateClip(),this._updateScale(),!e&&this._clipViewport&&this._updateClip()}get resizeSession(){return this._resizeSession}set resizeSession(e){this._resizeSession=e,e&&this._requestRemoteResize()}get showDotCursor(){return this._showDotCursor}set showDotCursor(e){this._showDotCursor=e,this._refreshCursor()}get background(){return this._screen.style.background}set background(e){this._screen.style.background=e}get qualityLevel(){return this._qualityLevel}set qualityLevel(e){!Number.isInteger(e)||e<0||e>9?Log.Error("qualityLevel must be an integer between 0 and 9"):this._qualityLevel!==e&&(this._qualityLevel=e,"connected"===this._rfb_connection_state&&this._sendEncodings())}disconnect(){this._updateConnectionState("disconnecting"),this._sock.off("error"),this._sock.off("message"),this._sock.off("open")}sendCredentials(e){this._rfb_credentials=e,setTimeout(this._init_msg.bind(this),0)}sendCtrlAltDel(){"connected"!==this._rfb_connection_state||this._viewOnly||(Log.Info("Sending Ctrl-Alt-Del"),this.sendKey(KeyTable.XK_Control_L,"ControlLeft",!0),this.sendKey(KeyTable.XK_Alt_L,"AltLeft",!0),this.sendKey(KeyTable.XK_Delete,"Delete",!0),this.sendKey(KeyTable.XK_Delete,"Delete",!1),this.sendKey(KeyTable.XK_Alt_L,"AltLeft",!1),this.sendKey(KeyTable.XK_Control_L,"ControlLeft",!1))}machineShutdown(){this._xvpOp(1,2)}machineReboot(){this._xvpOp(1,3)}machineReset(){this._xvpOp(1,4)}sendKey(e,t,s){if("connected"!==this._rfb_connection_state||this._viewOnly)return;if(void 0===s)return this.sendKey(e,t,!0),void this.sendKey(e,t,!1);const i=XtScancode[t];if(this._qemuExtKeyEventSupported&&i)e=e||0,Log.Info("Sending key ("+(s?"down":"up")+"): keysym "+e+", scancode "+i),RFB.messages.QEMUExtendedKeyEvent(this._sock,e,s,i);else{if(!e)return;Log.Info("Sending keysym ("+(s?"down":"up")+"): "+e),RFB.messages.keyEvent(this._sock,e,s?1:0)}}focus(){this._canvas.focus()}blur(){this._canvas.blur()}clipboardPasteFrom(e){if("connected"===this._rfb_connection_state&&!this._viewOnly)if(this._clipboardServerCapabilitiesFormats[1]&&this._clipboardServerCapabilitiesActions[134217728])this._clipboardText=e,RFB.messages.extendedClipboardNotify(this._sock,[1]);else{let t=new Uint8Array(e.length);for(let s=0;s<e.length;s++)t[s]=e.charCodeAt(s);RFB.messages.clientCutText(this._sock,t)}}_connect(){Log.Debug(">> RFB.connect"),Log.Info("connecting to "+this._url);try{this._sock.open(this._url,this._wsProtocols)}catch(e){"SyntaxError"===e.name?this._fail("Invalid host or port ("+e+")"):this._fail("Error when opening socket ("+e+")")}this._target.appendChild(this._screen),this._cursor.attach(this._canvas),this._refreshCursor(),window.addEventListener("resize",this._eventHandlers.windowResize),this._canvas.addEventListener("mousedown",this._eventHandlers.focusCanvas),this._canvas.addEventListener("touchstart",this._eventHandlers.focusCanvas),Log.Debug("<< RFB.connect")}_disconnect(){Log.Debug(">> RFB.disconnect"),this._cursor.detach(),this._canvas.removeEventListener("mousedown",this._eventHandlers.focusCanvas),this._canvas.removeEventListener("touchstart",this._eventHandlers.focusCanvas),window.removeEventListener("resize",this._eventHandlers.windowResize),this._keyboard.ungrab(),this._mouse.ungrab(),this._sock.close();try{this._target.removeChild(this._screen)}catch(e){if("NotFoundError"!==e.name)throw e}clearTimeout(this._resizeTimeout),Log.Debug("<< RFB.disconnect")}_focusCanvas(e){e.defaultPrevented||this.focusOnClick&&this.focus()}_setDesktopName(e){this._fb_name=e,this.dispatchEvent(new CustomEvent("desktopname",{detail:{name:this._fb_name}}))}_windowResize(e){window.requestAnimationFrame((()=>{this._updateClip(),this._updateScale()})),this._resizeSession&&(clearTimeout(this._resizeTimeout),this._resizeTimeout=setTimeout(this._requestRemoteResize.bind(this),500))}_updateClip(){const e=this._display.clipViewport;let t=this._clipViewport;if(this._scaleViewport&&(t=!1),e!==t&&(this._display.clipViewport=t),t){const e=this._screenSize();this._display.viewportChangeSize(e.w,e.h),this._fixScrollbars()}}_updateScale(){if(this._scaleViewport){const e=this._screenSize();this._display.autoscale(e.w,e.h)}else this._display.scale=1;this._fixScrollbars()}_requestRemoteResize(){if(clearTimeout(this._resizeTimeout),this._resizeTimeout=null,!this._resizeSession||this._viewOnly||!this._supportsSetDesktopSize)return;const e=this._screenSize();RFB.messages.setDesktopSize(this._sock,Math.floor(e.w),Math.floor(e.h),this._screen_id,this._screen_flags),Log.Debug("Requested new desktop size: "+e.w+"x"+e.h)}_screenSize(){let e=this._screen.getBoundingClientRect();const t={w:e.width,h:e.height};return(-1!==window.navigator.userAgent.indexOf("FBoxChef/1.0")||/Android|webOS|iPhone|iPod|Mobile/i.test(window.navigator.userAgent)||0===t.w&&0!==t.h||0!==t.w&&0===t.h)&&(t.w=document.documentElement.clientWidth,t.h=document.documentElement.clientHeight),t}_fixScrollbars(){const e=this._screen.style.overflow;this._screen.style.overflow="hidden",this._screen.getBoundingClientRect(),this._screen.style.overflow=e}_updateConnectionState(e){const t=this._rfb_connection_state;if(e!==t)if("disconnected"!==t){switch(e){case"connected":if("connecting"!==t)return void Log.Error("Bad transition to connected state, previous connection state: "+t);break;case"disconnected":if("disconnecting"!==t)return void Log.Error("Bad transition to disconnected state, previous connection state: "+t);break;case"connecting":if(""!==t)return void Log.Error("Bad transition to connecting state, previous connection state: "+t);break;case"disconnecting":if("connected"!==t&&"connecting"!==t)return void Log.Error("Bad transition to disconnecting state, previous connection state: "+t);break;default:return void Log.Error("Unknown connection state: "+e)}switch(this._rfb_connection_state=e,Log.Debug("New state '"+e+"', was '"+t+"'."),this._disconnTimer&&"disconnecting"!==e&&(Log.Debug("Clearing disconnect timer"),clearTimeout(this._disconnTimer),this._disconnTimer=null,this._sock.off("close")),e){case"connecting":this._connect();break;case"connected":this.dispatchEvent(new CustomEvent("connect",{detail:{}}));break;case"disconnecting":this._disconnect(),this._disconnTimer=setTimeout((()=>{Log.Error("Disconnection timed out."),this._updateConnectionState("disconnected")}),3e3);break;case"disconnected":this.dispatchEvent(new CustomEvent("disconnect",{detail:{clean:this._rfb_clean_disconnect}}))}}else Log.Error("Tried changing state of a disconnected RFB object");else Log.Debug("Already in state '"+e+"', ignoring")}_fail(e){switch(this._rfb_connection_state){case"disconnecting":Log.Error("Failed when disconnecting: "+e);break;case"connected":Log.Error("Failed while connected: "+e);break;case"connecting":Log.Error("Failed when connecting: "+e);break;default:Log.Error("RFB failure: "+e)}return this._rfb_clean_disconnect=!1,this._updateConnectionState("disconnecting"),this._updateConnectionState("disconnected"),!1}_setCapability(e,t){this._capabilities[e]=t,this.dispatchEvent(new CustomEvent("capabilities",{detail:{capabilities:this._capabilities}}))}_handle_message(){if(0!==this._sock.rQlen)switch(this._rfb_connection_state){case"disconnected":Log.Error("Got data while disconnected");break;case"connected":for(;!this._flushing&&this._normal_msg()&&0!==this._sock.rQlen;);break;default:this._init_msg()}else Log.Warn("handle_message called on an empty receive queue")}_handleKeyEvent(e,t,s){this.sendKey(e,t,s)}_handleMouseButton(e,t,s,i){if(s?(this._mouse_buttonMask|=i,this._mouse_buttonMaskLastMs=Date.now()):this._mouse_buttonMask&=~i,this.dragViewport){if(s&&!this._viewportDragging)return this._viewportDragging=!0,this._viewportDragPos={x:e,y:t},void(this._viewportHasMoved=!1);if(this._viewportDragging=!1,this._viewportHasMoved)return;RFB.messages.pointerEvent(this._sock,this._display.absX(e),this._display.absY(t),i)}this._viewOnly||"connected"===this._rfb_connection_state&&RFB.messages.pointerEvent(this._sock,this._display.absX(e),this._display.absY(t),this._mouse_buttonMask)}_handleMouseMove(e,t){if(0==this._mouse_buttonMask)return;if(this._viewportDragging){const s=this._viewportDragPos.x-e,i=this._viewportDragPos.y-t;return void((this._viewportHasMoved||Math.abs(s)>dragThreshold||Math.abs(i)>dragThreshold)&&(this._viewportHasMoved=!0,this._viewportDragPos={x:e,y:t},this._display.viewportChangePos(s,i)))}if(this._viewOnly)return;if("connected"!==this._rfb_connection_state)return;const s=Date.now()-this._mouse_buttonMaskLastMs;s<this.dragDelayMs||(this._mouse_buttonMaskLastMs+=s,RFB.messages.pointerEvent(this._sock,this._display.absX(e),this._display.absY(t),this._mouse_buttonMask))}_negotiate_protocol_version(){if(this._sock.rQwait("version",12))return!1;const e=this._sock.rQshiftStr(12).substr(4,7);Log.Info("Server ProtocolVersion: "+e);let t=0;switch(e){case"000.000":t=1;break;case"003.003":case"003.006":case"003.889":this._rfb_version=3.3;break;case"003.007":this._rfb_version=3.7;break;case"003.008":case"004.000":case"004.001":case"005.000":this._rfb_version=3.8;break;default:return this._fail("Invalid server version "+e)}if(t){let e="ID:"+this._repeaterID;for(;e.length<250;)e+="\0";return this._sock.send_string(e),!0}this._rfb_version>this._rfb_max_version&&(this._rfb_version=this._rfb_max_version);const s="00"+parseInt(this._rfb_version,10)+".00"+10*this._rfb_version%10;this._sock.send_string("RFB "+s+"\n"),Log.Debug("Sent ProtocolVersion: "+s),this._rfb_init_state="Security"}_negotiate_security(){function e(e,t){for(let s=0;s<t.length;s++)if(t[s]===e)return!0;return!1}if(this._rfb_version>=3.7){const t=this._sock.rQshift8();if(this._sock.rQwait("security type",t,1))return!1;if(0===t)return this._rfb_init_state="SecurityReason",this._security_context="no security types",this._security_status=1,this._init_msg();const s=this._sock.rQshiftBytes(t);if(Log.Debug("Server security types: "+s),e(1,s))this._rfb_auth_scheme=1;else if(e(22,s))this._rfb_auth_scheme=22;else if(e(16,s))this._rfb_auth_scheme=16;else{if(!e(2,s))return this._fail("Unsupported security types (types: "+s+")");this._rfb_auth_scheme=2}this._sock.send([this._rfb_auth_scheme])}else{if(this._sock.rQwait("security scheme",4))return!1;if(this._rfb_auth_scheme=this._sock.rQshift32(),0==this._rfb_auth_scheme)return this._rfb_init_state="SecurityReason",this._security_context="authentication scheme",this._security_status=1,this._init_msg()}return this._rfb_init_state="Authentication",Log.Debug("Authenticating using scheme: "+this._rfb_auth_scheme),this._init_msg()}_handle_security_reason(){if(this._sock.rQwait("reason length",4))return!1;const e=this._sock.rQshift32();let t="";if(e>0){if(this._sock.rQwait("reason",e,4))return!1;t=this._sock.rQshiftStr(e)}return""!==t?(this.dispatchEvent(new CustomEvent("securityfailure",{detail:{status:this._security_status,reason:t}})),this._fail("Security negotiation failed on "+this._security_context+" (reason: "+t+")")):(this.dispatchEvent(new CustomEvent("securityfailure",{detail:{status:this._security_status}})),this._fail("Security negotiation failed on "+this._security_context))}_negotiate_xvp_auth(){if(void 0===this._rfb_credentials.username||void 0===this._rfb_credentials.password||void 0===this._rfb_credentials.target)return this.dispatchEvent(new CustomEvent("credentialsrequired",{detail:{types:["username","password","target"]}})),!1;const e=String.fromCharCode(this._rfb_credentials.username.length)+String.fromCharCode(this._rfb_credentials.target.length)+this._rfb_credentials.username+this._rfb_credentials.target;return this._sock.send_string(e),this._rfb_auth_scheme=2,this._negotiate_authentication()}_negotiate_std_vnc_auth(){if(this._sock.rQwait("auth challenge",16))return!1;if(void 0===this._rfb_credentials.password)return this.dispatchEvent(new CustomEvent("credentialsrequired",{detail:{types:["password"]}})),!1;const e=Array.prototype.slice.call(this._sock.rQshiftBytes(16)),t=RFB.genDES(this._rfb_credentials.password,e);return this._sock.send(t),this._rfb_init_state="SecurityResult",!0}_negotiate_tight_unix_auth(){return void 0===this._rfb_credentials.username||void 0===this._rfb_credentials.password?(this.dispatchEvent(new CustomEvent("credentialsrequired",{detail:{types:["username","password"]}})),!1):(this._sock.send([0,0,0,this._rfb_credentials.username.length]),this._sock.send([0,0,0,this._rfb_credentials.password.length]),this._sock.send_string(this._rfb_credentials.username),this._sock.send_string(this._rfb_credentials.password),this._rfb_init_state="SecurityResult",!0)}_negotiate_tight_tunnels(e){const t={vendor:"TGHT",signature:"NOTUNNEL"},s={};for(let t=0;t<e;t++){const e=this._sock.rQshift32(),t=this._sock.rQshiftStr(4),i=this._sock.rQshiftStr(8);s[e]={vendor:t,signature:i}}return Log.Debug("Server Tight tunnel types: "+s),s[1]&&"SICR"===s[1].vendor&&"SCHANNEL"===s[1].signature&&(Log.Debug("Detected Siemens server. Assuming NOTUNNEL support."),s[0]={vendor:"TGHT",signature:"NOTUNNEL"}),s[0]?s[0].vendor!=t.vendor||s[0].signature!=t.signature?this._fail("Client's tunnel type had the incorrect vendor or signature"):(Log.Debug("Selected tunnel type: "+t),this._sock.send([0,0,0,0]),!1):this._fail("Server wanted tunnels, but doesn't support the notunnel type")}_negotiate_tight_auth(){if(!this._rfb_tightvnc){if(this._sock.rQwait("num tunnels",4))return!1;const e=this._sock.rQshift32();if(e>0&&this._sock.rQwait("tunnel capabilities",16*e,4))return!1;if(this._rfb_tightvnc=!0,e>0)return this._negotiate_tight_tunnels(e),!1}if(this._sock.rQwait("sub auth count",4))return!1;const e=this._sock.rQshift32();if(0===e)return this._rfb_init_state="SecurityResult",!0;if(this._sock.rQwait("sub auth capabilities",16*e,4))return!1;const t={STDVNOAUTH__:1,STDVVNCAUTH_:2,TGHTULGNAUTH:129},s=[];for(let t=0;t<e;t++){this._sock.rQshift32();const e=this._sock.rQshiftStr(12);s.push(e)}Log.Debug("Server Tight authentication types: "+s);for(let e in t)if(-1!=s.indexOf(e))switch(this._sock.send([0,0,0,t[e]]),Log.Debug("Selected authentication type: "+e),e){case"STDVNOAUTH__":return this._rfb_init_state="SecurityResult",!0;case"STDVVNCAUTH_":return this._rfb_auth_scheme=2,this._init_msg();case"TGHTULGNAUTH":return this._rfb_auth_scheme=129,this._init_msg();default:return this._fail("Unsupported tiny auth scheme (scheme: "+e+")")}return this._fail("No supported sub-auth types!")}_negotiate_authentication(){switch(this._rfb_auth_scheme){case 1:return this._rfb_version>=3.8?(this._rfb_init_state="SecurityResult",!0):(this._rfb_init_state="ClientInitialisation",this._init_msg());case 22:return this._negotiate_xvp_auth();case 2:return this._negotiate_std_vnc_auth();case 16:return this._negotiate_tight_auth();case 129:return this._negotiate_tight_unix_auth();default:return this._fail("Unsupported auth scheme (scheme: "+this._rfb_auth_scheme+")")}}_handle_security_result(){if(this._sock.rQwait("VNC auth response ",4))return!1;const e=this._sock.rQshift32();return 0===e?(this._rfb_init_state="ClientInitialisation",Log.Debug("Authentication OK"),this._init_msg()):this._rfb_version>=3.8?(this._rfb_init_state="SecurityReason",this._security_context="security result",this._security_status=e,this._init_msg()):(this.dispatchEvent(new CustomEvent("securityfailure",{detail:{status:e}})),this._fail("Security handshake failed"))}_negotiate_server_init(){if(this._sock.rQwait("server initialization",24))return!1;const e=this._sock.rQshift16(),t=this._sock.rQshift16(),s=this._sock.rQshift8(),i=this._sock.rQshift8(),n=this._sock.rQshift8(),r=this._sock.rQshift8(),o=this._sock.rQshift16(),h=this._sock.rQshift16(),a=this._sock.rQshift16(),c=this._sock.rQshift8(),_=this._sock.rQshift8(),d=this._sock.rQshift8();this._sock.rQskipBytes(3);const l=this._sock.rQshift32();if(this._sock.rQwait("server init name",l,24))return!1;let u=this._sock.rQshiftStr(l);if(u=decodeUTF8(u,!0),this._rfb_tightvnc){if(this._sock.rQwait("TightVNC extended server init header",8,24+l))return!1;const e=this._sock.rQshift16(),t=this._sock.rQshift16(),s=this._sock.rQshift16();this._sock.rQskipBytes(2);const i=16*(e+t+s);if(this._sock.rQwait("TightVNC extended server init header",i,32+l))return!1;this._sock.rQskipBytes(16*e),this._sock.rQskipBytes(16*t),this._sock.rQskipBytes(16*s)}return Log.Info("Screen: "+e+"x"+t+", bpp: "+s+", depth: "+i+", big_endian: "+n+", true_color: "+r+", red_max: "+o+", green_max: "+h+", blue_max: "+a+", red_shift: "+c+", green_shift: "+_+", blue_shift: "+d),this._setDesktopName(u),this._resize(e,t),this._viewOnly||this._keyboard.grab(),this._viewOnly||this._mouse.grab(),this._fb_depth=24,"Intel(r) AMT KVM"===this._fb_name&&(Log.Warn("Intel AMT KVM only supports 8/16 bit depths. Using low color mode."),this._fb_depth=8),RFB.messages.pixelFormat(this._sock,this._fb_depth,!0),this._sendEncodings(),RFB.messages.fbUpdateRequest(this._sock,!1,0,0,this._fb_width,this._fb_height),this._updateConnectionState("connected"),!0}_sendEncodings(){const e=[];e.push(encodings.encodingCopyRect),24==this._fb_depth&&(e.push(encodings.encodingTight),e.push(encodings.encodingTightPNG),e.push(encodings.encodingHextile),e.push(encodings.encodingRRE)),e.push(encodings.encodingRaw),e.push(encodings.pseudoEncodingQualityLevel0+this._qualityLevel),e.push(encodings.pseudoEncodingCompressLevel0+2),e.push(encodings.pseudoEncodingDesktopSize),e.push(encodings.pseudoEncodingLastRect),e.push(encodings.pseudoEncodingQEMUExtendedKeyEvent),e.push(encodings.pseudoEncodingExtendedDesktopSize),e.push(encodings.pseudoEncodingXvp),e.push(encodings.pseudoEncodingFence),e.push(encodings.pseudoEncodingContinuousUpdates),e.push(encodings.pseudoEncodingDesktopName),e.push(encodings.pseudoEncodingExtendedClipboard),24==this._fb_depth&&(e.push(encodings.pseudoEncodingVMwareCursor),e.push(encodings.pseudoEncodingCursor)),RFB.messages.clientEncodings(this._sock,e)}_init_msg(){switch(this._rfb_init_state){case"ProtocolVersion":return this._negotiate_protocol_version();case"Security":return this._negotiate_security();case"Authentication":return this._negotiate_authentication();case"SecurityResult":return this._handle_security_result();case"SecurityReason":return this._handle_security_reason();case"ClientInitialisation":return this._sock.send([this._shared?1:0]),this._rfb_init_state="ServerInitialisation",!0;case"ServerInitialisation":return this._negotiate_server_init();default:return this._fail("Unknown init state (state: "+this._rfb_init_state+")")}}_handle_set_colour_map_msg(){return Log.Debug("SetColorMapEntries"),this._fail("Unexpected SetColorMapEntries message")}_handle_server_cut_text(){if(Log.Debug("ServerCutText"),this._sock.rQwait("ServerCutText header",7,1))return!1;this._sock.rQskipBytes(3);let e=this._sock.rQshift32();if(e=toSigned32bit(e),this._sock.rQwait("ServerCutText content",Math.abs(e),8))return!1;if(e>=0){const t=this._sock.rQshiftStr(e);if(this._viewOnly)return!0;this.dispatchEvent(new CustomEvent("clipboard",{detail:{text:t}}))}else{e=Math.abs(e);const t=this._sock.rQshift32();let s=65535&t,i=4278190080&t;if(!!(16777216&i)){this._clipboardServerCapabilitiesFormats={},this._clipboardServerCapabilitiesActions={};for(let e=0;e<=15;e++){let t=1<<e;s&t&&(this._clipboardServerCapabilitiesFormats[t]=!0,this._sock.rQshift32())}for(let e=24;e<=31;e++){let t=1<<e;this._clipboardServerCapabilitiesActions[t]=!!(i&t)}let e=[16777216,33554432,67108864,134217728,268435456];RFB.messages.extendedClipboardCaps(this._sock,e,{extendedClipboardFormatText:0})}else if(33554432===i){if(this._viewOnly)return!0;null!=this._clipboardText&&this._clipboardServerCapabilitiesActions[268435456]&&1&s&&RFB.messages.extendedClipboardProvide(this._sock,[1],[this._clipboardText])}else if(67108864===i){if(this._viewOnly)return!0;this._clipboardServerCapabilitiesActions[134217728]&&(null!=this._clipboardText?RFB.messages.extendedClipboardNotify(this._sock,[1]):RFB.messages.extendedClipboardNotify(this._sock,[]))}else if(134217728===i){if(this._viewOnly)return!0;this._clipboardServerCapabilitiesActions[33554432]&&1&s&&RFB.messages.extendedClipboardRequest(this._sock,[1])}else{if(268435456!==i)return this._fail("Unexpected action in extended clipboard message: "+i);{if(this._viewOnly)return!0;if(!(1&s))return!0;this._clipboardText=null;let t=this._sock.rQshiftBytes(e-4),i=new Inflator,n=null;i.setInput(t);for(let e=0;e<=15;e++){let t=1<<e;if(s&t){let e=0,s=i.inflate(4);e|=s[0]<<24,e|=s[1]<<16,e|=s[2]<<8,e|=s[3];let r=i.inflate(e);1===t&&(n=r)}}if(i.setInput(null),null!==n){let e="";for(let t=0;t<n.length;t++)e+=String.fromCharCode(n[t]);n=e,n=decodeUTF8(n),n.length>0&&"\0"===n.charAt(n.length-1)&&(n=n.slice(0,-1)),n=n.replace("\r\n","\n"),this.dispatchEvent(new CustomEvent("clipboard",{detail:{text:n}}))}}}}return!0}_handle_server_fence_msg(){if(this._sock.rQwait("ServerFence header",8,1))return!1;this._sock.rQskipBytes(3);let e=this._sock.rQshift32(),t=this._sock.rQshift8();if(this._sock.rQwait("ServerFence payload",t,9))return!1;t>64&&(Log.Warn("Bad payload length ("+t+") in fence response"),t=64);const s=this._sock.rQshiftStr(t);return this._supportsFence=!0,e&1<<31?(e&=3,RFB.messages.clientFence(this._sock,e,s),!0):this._fail("Unexpected fence response")}_handle_xvp_msg(){if(this._sock.rQwait("XVP version and message",3,1))return!1;this._sock.rQskipBytes(1);const e=this._sock.rQshift8(),t=this._sock.rQshift8();switch(t){case 0:Log.Error("XVP Operation Failed");break;case 1:this._rfb_xvp_ver=e,Log.Info("XVP extensions enabled (version "+this._rfb_xvp_ver+")"),this._setCapability("power",!0);break;default:this._fail("Illegal server XVP message (msg: "+t+")")}return!0}_normal_msg(){let e,t,s;switch(e=this._FBU.rects>0?0:this._sock.rQshift8(),e){case 0:return s=this._framebufferUpdate(),s&&!this._enabledContinuousUpdates&&RFB.messages.fbUpdateRequest(this._sock,!0,0,0,this._fb_width,this._fb_height),s;case 1:return this._handle_set_colour_map_msg();case 2:return Log.Debug("Bell"),this.dispatchEvent(new CustomEvent("bell",{detail:{}})),!0;case 3:return this._handle_server_cut_text();case 150:return t=!this._supportsContinuousUpdates,this._supportsContinuousUpdates=!0,this._enabledContinuousUpdates=!1,t&&(this._enabledContinuousUpdates=!0,this._updateContinuousUpdates(),Log.Info("Enabling continuous updates.")),!0;case 248:return this._handle_server_fence_msg();case 250:return this._handle_xvp_msg();default:return this._fail("Unexpected server message (type "+e+")"),Log.Debug("sock.rQslice(0, 30): "+this._sock.rQslice(0,30)),!0}}_onFlush(){this._flushing=!1,this._sock.rQlen>0&&this._handle_message()}_framebufferUpdate(){if(0===this._FBU.rects){if(this._sock.rQwait("FBU header",3,1))return!1;if(this._sock.rQskipBytes(1),this._FBU.rects=this._sock.rQshift16(),this._display.pending())return this._flushing=!0,this._display.flush(),!1}for(;this._FBU.rects>0;){if(null===this._FBU.encoding){if(this._sock.rQwait("rect header",12))return!1;const e=this._sock.rQshiftBytes(12);this._FBU.x=(e[0]<<8)+e[1],this._FBU.y=(e[2]<<8)+e[3],this._FBU.width=(e[4]<<8)+e[5],this._FBU.height=(e[6]<<8)+e[7],this._FBU.encoding=parseInt((e[8]<<24)+(e[9]<<16)+(e[10]<<8)+e[11],10)}if(!this._handleRect())return!1;this._FBU.rects--,this._FBU.encoding=null}return this._display.flip(),!0}_handleRect(){switch(this._FBU.encoding){case encodings.pseudoEncodingLastRect:return this._FBU.rects=1,!0;case encodings.pseudoEncodingVMwareCursor:return this._handleVMwareCursor();case encodings.pseudoEncodingCursor:return this._handleCursor();case encodings.pseudoEncodingQEMUExtendedKeyEvent:try{void 0!==document.createEvent("keyboardEvent").code&&(this._qemuExtKeyEventSupported=!0)}catch(e){}return!0;case encodings.pseudoEncodingDesktopName:return this._handleDesktopName();case encodings.pseudoEncodingDesktopSize:return this._resize(this._FBU.width,this._FBU.height),!0;case encodings.pseudoEncodingExtendedDesktopSize:return this._handleExtendedDesktopSize();default:return this._handleDataRect()}}_handleVMwareCursor(){const e=this._FBU.x,t=this._FBU.y,s=this._FBU.width,i=this._FBU.height;if(this._sock.rQwait("VMware cursor encoding",1))return!1;const n=this._sock.rQshift8();let r;this._sock.rQshift8();if(0==n){const e=-256;if(r=new Array(s*i*4),this._sock.rQwait("VMware cursor classic encoding",s*i*4*2,2))return!1;let t=new Array(s*i);for(let e=0;e<s*i;e++)t[e]=this._sock.rQshift32();let n=new Array(s*i);for(let e=0;e<s*i;e++)n[e]=this._sock.rQshift32();for(let o=0;o<s*i;o++)if(0==t[o]){let e=n[o],t=e>>8&255,s=e>>16&255,i=e>>24&255;r[4*o]=t,r[4*o+1]=s,r[4*o+2]=i,r[4*o+3]=255}else(t[o]&e)==e?0==n[o]?(r[4*o]=0,r[4*o+1]=0,r[4*o+2]=0,r[4*o+3]=0):(n[o],r[4*o]=0,r[4*o+1]=0,r[4*o+2]=0,r[4*o+3]=255):(r[4*o]=0,r[4*o+1]=0,r[4*o+2]=0,r[4*o+3]=255)}else{if(1!=n)return Log.Warn("The given cursor type is not supported: "+n+" given."),!1;if(this._sock.rQwait("VMware cursor alpha encoding",s*i*4,2))return!1;r=new Array(s*i*4);for(let e=0;e<s*i;e++){let t=this._sock.rQshift32();r[4*e]=t>>24&255,r[4*e+1]=t>>16&255,r[4*e+2]=t>>8&255,r[4*e+3]=255&t}}return this._updateCursor(r,e,t,s,i),!0}_handleCursor(){const e=this._FBU.x,t=this._FBU.y,s=this._FBU.width,i=this._FBU.height,n=s*i*4,r=Math.ceil(s/8)*i;let o=n+r;if(this._sock.rQwait("cursor encoding",o))return!1;const h=this._sock.rQshiftBytes(n),a=this._sock.rQshiftBytes(r);let c=new Uint8Array(s*i*4),_=0;for(let e=0;e<i;e++)for(let t=0;t<s;t++){let i=a[e*Math.ceil(s/8)+Math.floor(t/8)]<<t%8&128?255:0;c[_]=h[_+2],c[_+1]=h[_+1],c[_+2]=h[_],c[_+3]=i,_+=4}return this._updateCursor(c,e,t,s,i),!0}_handleDesktopName(){if(this._sock.rQwait("DesktopName",4))return!1;let e=this._sock.rQshift32();if(this._sock.rQwait("DesktopName",e,4))return!1;let t=this._sock.rQshiftStr(e);return t=decodeUTF8(t,!0),this._setDesktopName(t),!0}_handleExtendedDesktopSize(){if(this._sock.rQwait("ExtendedDesktopSize",4))return!1;const e=this._sock.rQpeek8();let t=4+16*e;if(this._sock.rQwait("ExtendedDesktopSize",t))return!1;const s=!this._supportsSetDesktopSize;this._supportsSetDesktopSize=!0,s&&this._requestRemoteResize(),this._sock.rQskipBytes(1),this._sock.rQskipBytes(3);for(let t=0;t<e;t+=1)0===t?(this._screen_id=this._sock.rQshiftBytes(4),this._sock.rQskipBytes(2),this._sock.rQskipBytes(2),this._sock.rQskipBytes(2),this._sock.rQskipBytes(2),this._screen_flags=this._sock.rQshiftBytes(4)):this._sock.rQskipBytes(16);if(1===this._FBU.x&&0!==this._FBU.y){let e="";switch(this._FBU.y){case 1:e="Resize is administratively prohibited";break;case 2:e="Out of resources";break;case 3:e="Invalid screen layout";break;default:e="Unknown reason"}Log.Warn("Server did not accept the resize request: "+e)}else this._resize(this._FBU.width,this._FBU.height);return!0}_handleDataRect(){let e=this._decoders[this._FBU.encoding];if(!e)return this._fail("Unsupported encoding (encoding: "+this._FBU.encoding+")"),!1;try{return e.decodeRect(this._FBU.x,this._FBU.y,this._FBU.width,this._FBU.height,this._sock,this._display,this._fb_depth)}catch(e){return this._fail("Error decoding rect: "+e),!1}}_updateContinuousUpdates(){this._enabledContinuousUpdates&&RFB.messages.enableContinuousUpdates(this._sock,!0,0,0,this._fb_width,this._fb_height)}_resize(e,t){this._fb_width=e,this._fb_height=t,this._display.resize(this._fb_width,this._fb_height),this._updateClip(),this._updateScale(),this._updateContinuousUpdates()}_xvpOp(e,t){this._rfb_xvp_ver<e||(Log.Info("Sending XVP operation "+t+" (version "+e+")"),RFB.messages.xvpOp(this._sock,e,t))}_updateCursor(e,t,s,i,n){this._cursorImage={rgbaPixels:e,hotx:t,hoty:s,w:i,h:n},this._refreshCursor()}_shouldShowDotCursor(){if(!this._showDotCursor)return!1;for(let e=3;e<this._cursorImage.rgbaPixels.length;e+=4)if(this._cursorImage.rgbaPixels[e])return!1;return!0}_refreshCursor(){if("connecting"!==this._rfb_connection_state&&"connected"!==this._rfb_connection_state)return;const e=this._shouldShowDotCursor()?RFB.cursors.dot:this._cursorImage;this._cursor.change(e.rgbaPixels,e.hotx,e.hoty,e.w,e.h)}static genDES(e,t){const s=e.split("").map((e=>e.charCodeAt(0)));return new DES(s).encrypt(t)}}RFB.messages={keyEvent(e,t,s){const i=e._sQ,n=e._sQlen;i[n]=4,i[n+1]=s,i[n+2]=0,i[n+3]=0,i[n+4]=t>>24,i[n+5]=t>>16,i[n+6]=t>>8,i[n+7]=t,e._sQlen+=8,e.flush()},QEMUExtendedKeyEvent(e,t,s,i){const n=e._sQ,r=e._sQlen;n[r]=255,n[r+1]=0,n[r+2]=s>>8,n[r+3]=s,n[r+4]=t>>24,n[r+5]=t>>16,n[r+6]=t>>8,n[r+7]=t;const o=function(e){const t=255&i;return 224===i>>8&&t<127?128|t:e}(i);n[r+8]=o>>24,n[r+9]=o>>16,n[r+10]=o>>8,n[r+11]=o,e._sQlen+=12,e.flush()},pointerEvent(e,t,s,i){const n=e._sQ,r=e._sQlen;n[r]=5,n[r+1]=i,n[r+2]=t>>8,n[r+3]=t,n[r+4]=s>>8,n[r+5]=s,e._sQlen+=6,e.flush()},_buildExtendedClipboardFlags(e,t){let s=new Uint8Array(4),i=0,n=0;for(let t=0;t<e.length;t++)n|=e[t];for(let e=0;e<t.length;e++)i|=t[e];return s[0]=n>>24,s[1]=0,s[2]=0,s[3]=i,s},extendedClipboardProvide(e,t,s){let i=new Deflator,n=[];for(let e=0;e<t.length;e++){if(1!=t[e])throw new Error("Unsupported extended clipboard format for Provide message.");s[e]=s[e].replace(/\r\n|\r|\n/gm,"\r\n");let i=encodeUTF8(s[e]+"\0");n.push(i.length>>24&255,i.length>>16&255,i.length>>8&255,255&i.length);for(let e=0;e<i.length;e++)n.push(i.charCodeAt(e))}let r=i.deflate(new Uint8Array(n)),o=new Uint8Array(4+r.length);o.set(RFB.messages._buildExtendedClipboardFlags([268435456],t)),o.set(r,4),RFB.messages.clientCutText(e,o,!0)},extendedClipboardNotify(e,t){let s=RFB.messages._buildExtendedClipboardFlags([134217728],t);RFB.messages.clientCutText(e,s,!0)},extendedClipboardRequest(e,t){let s=RFB.messages._buildExtendedClipboardFlags([33554432],t);RFB.messages.clientCutText(e,s,!0)},extendedClipboardCaps(e,t,s){let i=Object.keys(s),n=new Uint8Array(4+4*i.length);i.map((e=>parseInt(e))),i.sort(((e,t)=>e-t)),n.set(RFB.messages._buildExtendedClipboardFlags(t,[]));let r=4;for(let e=0;e<i.length;e++)n[r]=s[i[e]]>>24,n[r+1]=s[i[e]]>>16,n[r+2]=s[i[e]]>>8,n[r+3]=s[i[e]]|0,r+=4,n[3]|=1<<i[e];RFB.messages.clientCutText(e,n,!0)},clientCutText(e,t,s=!1){const i=e._sQ,n=e._sQlen;let r;i[n]=6,i[n+1]=0,i[n+2]=0,i[n+3]=0,r=s?toUnsigned32bit(-t.length):t.length,i[n+4]=r>>24,i[n+5]=r>>16,i[n+6]=r>>8,i[n+7]=r,e._sQlen+=8;let o=0,h=t.length;for(;h>0;){let s=Math.min(h,e._sQbufferSize-e._sQlen);for(let n=0;n<s;n++)i[e._sQlen+n]=t[o+n];e._sQlen+=s,e.flush(),h-=s,o+=s}},setDesktopSize(e,t,s,i,n){const r=e._sQ,o=e._sQlen;r[o]=251,r[o+1]=0,r[o+2]=t>>8,r[o+3]=t,r[o+4]=s>>8,r[o+5]=s,r[o+6]=1,r[o+7]=0,r[o+8]=i>>24,r[o+9]=i>>16,r[o+10]=i>>8,r[o+11]=i,r[o+12]=0,r[o+13]=0,r[o+14]=0,r[o+15]=0,r[o+16]=t>>8,r[o+17]=t,r[o+18]=s>>8,r[o+19]=s,r[o+20]=n>>24,r[o+21]=n>>16,r[o+22]=n>>8,r[o+23]=n,e._sQlen+=24,e.flush()},clientFence(e,t,s){const i=e._sQ,n=e._sQlen;i[n]=248,i[n+1]=0,i[n+2]=0,i[n+3]=0,i[n+4]=t>>24,i[n+5]=t>>16,i[n+6]=t>>8,i[n+7]=t;const r=s.length;i[n+8]=r;for(let e=0;e<r;e++)i[n+9+e]=s.charCodeAt(e);e._sQlen+=9+r,e.flush()},enableContinuousUpdates(e,t,s,i,n,r){const o=e._sQ,h=e._sQlen;o[h]=150,o[h+1]=t,o[h+2]=s>>8,o[h+3]=s,o[h+4]=i>>8,o[h+5]=i,o[h+6]=n>>8,o[h+7]=n,o[h+8]=r>>8,o[h+9]=r,e._sQlen+=10,e.flush()},pixelFormat(e,t,s){const i=e._sQ,n=e._sQlen;let r;r=t>16?32:t>8?16:8;const o=Math.floor(t/3);i[n]=0,i[n+1]=0,i[n+2]=0,i[n+3]=0,i[n+4]=r,i[n+5]=t,i[n+6]=0,i[n+7]=s?1:0,i[n+8]=0,i[n+9]=(1<<o)-1,i[n+10]=0,i[n+11]=(1<<o)-1,i[n+12]=0,i[n+13]=(1<<o)-1,i[n+14]=2*o,i[n+15]=1*o,i[n+16]=0*o,i[n+17]=0,i[n+18]=0,i[n+19]=0,e._sQlen+=20,e.flush()},clientEncodings(e,t){const s=e._sQ,i=e._sQlen;s[i]=2,s[i+1]=0,s[i+2]=t.length>>8,s[i+3]=t.length;let n=i+4;for(let e=0;e<t.length;e++){const i=t[e];s[n]=i>>24,s[n+1]=i>>16,s[n+2]=i>>8,s[n+3]=i,n+=4}e._sQlen+=n-i,e.flush()},fbUpdateRequest(e,t,s,i,n,r){const o=e._sQ,h=e._sQlen;void 0===s&&(s=0),void 0===i&&(i=0),o[h]=3,o[h+1]=t?1:0,o[h+2]=s>>8&255,o[h+3]=255&s,o[h+4]=i>>8&255,o[h+5]=255&i,o[h+6]=n>>8&255,o[h+7]=255&n,o[h+8]=r>>8&255,o[h+9]=255&r,e._sQlen+=10,e.flush()},xvpOp(e,t,s){const i=e._sQ,n=e._sQlen;i[n]=250,i[n+1]=0,i[n+2]=t,i[n+3]=s,e._sQlen+=4,e.flush()}},RFB.cursors={none:{rgbaPixels:new Uint8Array,w:0,h:0,hotx:0,hoty:0},dot:{rgbaPixels:new Uint8Array([255,255,255,255,0,0,0,255,255,255,255,255,0,0,0,255,0,0,0,0,0,0,0,255,255,255,255,255,0,0,0,255,255,255,255,255]),w:3,h:3,hotx:1,hoty:1}};
//# sourceMappingURL=/sm/4d3c50f60ab8f1252415122cf5f1561933859d788c51a68271dfae0a4502b686.map