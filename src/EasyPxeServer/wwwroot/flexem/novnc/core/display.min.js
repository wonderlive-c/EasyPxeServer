/**
 * Minified by jsDelivr using Terser v5.39.0.
 * Original file: /npm/@flexem/novnc@1.1.6/core/display.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import*as Log from"./util/logging.js";import Base64 from"./base64.js";import{supportsImageMetadata}from"./util/browser.js";export default class Display{constructor(t){if(this._drawCtx=null,this._c_forceCanvas=!1,this._renderQ=[],this._flushing=!1,this._fb_width=0,this._fb_height=0,this._prevDrawStyle="",this._tile=null,this._tile16x16=null,this._tile_x=0,this._tile_y=0,Log.Debug(">> Display.constructor"),this._target=t,!this._target)throw new Error("Target must be set");if("string"==typeof this._target)throw new Error("target must be a DOM element");if(!this._target.getContext)throw new Error("no getContext method");if(this._targetCtx=this._target.getContext("2d"),this._viewportLoc={x:0,y:0,w:this._target.width,h:this._target.height},this._backbuffer=document.createElement("canvas"),this._drawCtx=this._backbuffer.getContext("2d"),this._damageBounds={left:0,top:0,right:this._backbuffer.width,bottom:this._backbuffer.height},Log.Debug("User Agent: "+navigator.userAgent),!("createImageData"in this._drawCtx))throw new Error("Canvas does not support createImageData");this._tile16x16=this._drawCtx.createImageData(16,16),Log.Debug("<< Display.constructor"),this._scale=1,this._clipViewport=!1,this.onflush=()=>{}}get scale(){return this._scale}set scale(t){this._rescale(t)}get clipViewport(){return this._clipViewport}set clipViewport(t){this._clipViewport=t;const e=this._viewportLoc;this.viewportChangeSize(e.w,e.h),this.viewportChangePos(0,0)}get width(){return this._fb_width}get height(){return this._fb_height}viewportChangePos(t,e){const i=this._viewportLoc;t=Math.floor(t),e=Math.floor(e),this._clipViewport||(t=-i.w,e=-i.h);const h=i.x+i.w-1,s=i.y+i.h-1;t<0&&i.x+t<0&&(t=-i.x),h+t>=this._fb_width&&(t-=h+t-this._fb_width+1),i.y+e<0&&(e=-i.y),s+e>=this._fb_height&&(e-=s+e-this._fb_height+1),0===t&&0===e||(Log.Debug("viewportChange deltaX: "+t+", deltaY: "+e),i.x+=t,i.y+=e,this._damage(i.x,i.y,i.w,i.h),this.flip())}viewportChangeSize(t,e){this._clipViewport&&void 0!==t&&void 0!==e||(Log.Debug("Setting viewport to full display region"),t=this._fb_width,e=this._fb_height),t=Math.floor(t),e=Math.floor(e),t>this._fb_width&&(t=this._fb_width),e>this._fb_height&&(e=this._fb_height);const i=this._viewportLoc;if(i.w!==t||i.h!==e){i.w=t,i.h=e;const h=this._target;h.width=t,h.height=e,this.viewportChangePos(0,0),this._damage(i.x,i.y,i.w,i.h),this.flip(),this._rescale(this._scale)}}absX(t){return 0===this._scale?0:t/this._scale+this._viewportLoc.x}absY(t){return 0===this._scale?0:t/this._scale+this._viewportLoc.y}resize(t,e){this._prevDrawStyle="",this._fb_width=t,this._fb_height=e;const i=this._backbuffer;if(i.width!==t||i.height!==e){let h=null;i.width>0&&i.height>0&&(h=this._drawCtx.getImageData(0,0,i.width,i.height)),i.width!==t&&(i.width=t),i.height!==e&&(i.height=e),h&&this._drawCtx.putImageData(h,0,0)}const h=this._viewportLoc;this.viewportChangeSize(h.w,h.h),this.viewportChangePos(0,0)}_damage(t,e,i,h){t<this._damageBounds.left&&(this._damageBounds.left=t),e<this._damageBounds.top&&(this._damageBounds.top=e),t+i>this._damageBounds.right&&(this._damageBounds.right=t+i),e+h>this._damageBounds.bottom&&(this._damageBounds.bottom=e+h)}flip(t){if(0===this._renderQ.length||t){let t=this._damageBounds.left,e=this._damageBounds.top,i=this._damageBounds.right-t,h=this._damageBounds.bottom-e,s=t-this._viewportLoc.x,a=e-this._viewportLoc.y;s<0&&(i+=s,t-=s,s=0),a<0&&(h+=a,e-=a,a=0),s+i>this._viewportLoc.w&&(i=this._viewportLoc.w-s),a+h>this._viewportLoc.h&&(h=this._viewportLoc.h-a),i>0&&h>0&&this._targetCtx.drawImage(this._backbuffer,t,e,i,h,s,a,i,h),this._damageBounds.left=this._damageBounds.top=65535,this._damageBounds.right=this._damageBounds.bottom=0}else this._renderQ_push({type:"flip"})}pending(){return this._renderQ.length>0}flush(){0===this._renderQ.length?this.onflush():this._flushing=!0}fillRect(t,e,i,h,s,a){0===this._renderQ.length||a?(this._setFillColor(s),this._drawCtx.fillRect(t,e,i,h),this._damage(t,e,i,h)):this._renderQ_push({type:"fill",x:t,y:e,width:i,height:h,color:s})}copyImage(t,e,i,h,s,a,r){0===this._renderQ.length||r?(this._drawCtx.mozImageSmoothingEnabled=!1,this._drawCtx.webkitImageSmoothingEnabled=!1,this._drawCtx.msImageSmoothingEnabled=!1,this._drawCtx.imageSmoothingEnabled=!1,this._drawCtx.drawImage(this._backbuffer,t,e,s,a,i,h,s,a),this._damage(i,h,s,a)):this._renderQ_push({type:"copy",old_x:t,old_y:e,x:i,y:h,width:s,height:a})}imageRect(t,e,i,h,s,a){if(0===i||0===h)return;const r=new Image;r.src="data: "+s+";base64,"+Base64.encode(a),this._renderQ_push({type:"img",img:r,x:t,y:e,width:i,height:h})}startTile(t,e,i,h,s){this._tile_x=t,this._tile_y=e,this._tile=16===i&&16===h?this._tile16x16:this._drawCtx.createImageData(i,h);const a=s[2],r=s[1],_=s[0],g=this._tile.data;for(let t=0;t<i*h*4;t+=4)g[t]=a,g[t+1]=r,g[t+2]=_,g[t+3]=255}subTile(t,e,i,h,s){const a=s[2],r=s[1],_=s[0],g=t+i,o=e+h,d=this._tile.data,n=this._tile.width;for(let i=e;i<o;i++)for(let e=t;e<g;e++){const t=4*(e+i*n);d[t]=a,d[t+1]=r,d[t+2]=_,d[t+3]=255}}finishTile(){this._drawCtx.putImageData(this._tile,this._tile_x,this._tile_y),this._damage(this._tile_x,this._tile_y,this._tile.width,this._tile.height)}blitImage(t,e,i,h,s,a,r){if(0===this._renderQ.length||r)this._bgrxImageData(t,e,i,h,s,a);else{const a=new Uint8Array(i*h*4);a.set(new Uint8Array(s.buffer,0,a.length)),this._renderQ_push({type:"blit",data:a,x:t,y:e,width:i,height:h})}}blitRgbImage(t,e,i,h,s,a,r){if(0===this._renderQ.length||r)this._rgbImageData(t,e,i,h,s,a);else{const a=new Uint8Array(i*h*3);a.set(new Uint8Array(s.buffer,0,a.length)),this._renderQ_push({type:"blitRgb",data:a,x:t,y:e,width:i,height:h})}}blitRgbxImage(t,e,i,h,s,a,r){if(0===this._renderQ.length||r)this._rgbxImageData(t,e,i,h,s,a);else{const a=new Uint8Array(i*h*4);a.set(new Uint8Array(s.buffer,0,a.length)),this._renderQ_push({type:"blitRgbx",data:a,x:t,y:e,width:i,height:h})}}drawImage(t,e,i){this._drawCtx.drawImage(t,e,i),this._damage(e,i,t.width,t.height)}autoscale(t,e){let i;if(0===t||0===e)i=0;else{const h=this._viewportLoc,s=t/e;i=h.w/h.h>=s?t/h.w:e/h.h}this._rescale(i)}_rescale(t){this._scale=t;const e=this._viewportLoc,i=t*e.w+"px",h=t*e.h+"px";this._target.style.width===i&&this._target.style.height===h||(this._target.style.width=i,this._target.style.height=h)}_setFillColor(t){const e="rgb("+t[2]+","+t[1]+","+t[0]+")";e!==this._prevDrawStyle&&(this._drawCtx.fillStyle=e,this._prevDrawStyle=e)}_rgbImageData(t,e,i,h,s,a){const r=this._drawCtx.createImageData(i,h),_=r.data;for(let t=0,e=a;t<i*h*4;t+=4,e+=3)_[t]=s[e],_[t+1]=s[e+1],_[t+2]=s[e+2],_[t+3]=255;this._drawCtx.putImageData(r,t,e),this._damage(t,e,r.width,r.height)}_bgrxImageData(t,e,i,h,s,a){const r=this._drawCtx.createImageData(i,h),_=r.data;for(let t=0,e=a;t<i*h*4;t+=4,e+=4)_[t]=s[e+2],_[t+1]=s[e+1],_[t+2]=s[e],_[t+3]=255;this._drawCtx.putImageData(r,t,e),this._damage(t,e,r.width,r.height)}_rgbxImageData(t,e,i,h,s,a){let r;supportsImageMetadata?r=new ImageData(new Uint8ClampedArray(s.buffer,s.byteOffset,i*h*4),i,h):(r=this._drawCtx.createImageData(i,h),r.data.set(new Uint8ClampedArray(s.buffer,s.byteOffset,i*h*4))),this._drawCtx.putImageData(r,t,e),this._damage(t,e,r.width,r.height)}_renderQ_push(t){this._renderQ.push(t),1===this._renderQ.length&&this._scan_renderQ()}_resume_renderQ(){this.removeEventListener("load",this._noVNC_display._resume_renderQ),this._noVNC_display._scan_renderQ()}_scan_renderQ(){let t=!0;for(;t&&this._renderQ.length>0;){const e=this._renderQ[0];switch(e.type){case"flip":this.flip(!0);break;case"copy":this.copyImage(e.old_x,e.old_y,e.x,e.y,e.width,e.height,!0);break;case"fill":this.fillRect(e.x,e.y,e.width,e.height,e.color,!0);break;case"blit":this.blitImage(e.x,e.y,e.width,e.height,e.data,0,!0);break;case"blitRgb":this.blitRgbImage(e.x,e.y,e.width,e.height,e.data,0,!0);break;case"blitRgbx":this.blitRgbxImage(e.x,e.y,e.width,e.height,e.data,0,!0);break;case"img":if(e.img.complete&&0!==e.img.width&&0!==e.img.height){if(e.img.width!==e.width||e.img.height!==e.height)return void Log.Error("Decoded image has incorrect dimensions. Got "+e.img.width+"x"+e.img.height+". Expected "+e.width+"x"+e.height+".");this.drawImage(e.img,e.x,e.y)}else e.img._noVNC_display=this,e.img.addEventListener("load",this._resume_renderQ),t=!1}t&&this._renderQ.shift()}0===this._renderQ.length&&this._flushing&&(this._flushing=!1,this.onflush())}}
//# sourceMappingURL=/sm/9b783ae734f84ea2aeab2e7db178a972da71144987b240a25fb45625353bdee8.map